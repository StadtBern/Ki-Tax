{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/kindView/kindView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/kindView/kindView.ts","mtime":1512484412015},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["\"use strict\";\n/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar TSKind_1 = require(\"../../../models/TSKind\");\nvar EnumEx_1 = require(\"../../../utils/EnumEx\");\nvar TSGeschlecht_1 = require(\"../../../models/enums/TSGeschlecht\");\nvar abstractGesuchView_1 = require(\"../abstractGesuchView\");\nvar TSPensumFachstelle_1 = require(\"../../../models/TSPensumFachstelle\");\nvar TSKindContainer_1 = require(\"../../../models/TSKindContainer\");\nvar TSKinderabzug_1 = require(\"../../../models/enums/TSKinderabzug\");\nvar DateUtil_1 = require(\"../../../utils/DateUtil\");\nvar TSWizardStepName_1 = require(\"../../../models/enums/TSWizardStepName\");\nvar template = require('./kindView.html');\nrequire('./kindView.less');\nvar KindViewComponentConfig = /** @class */ (function () {\n    function KindViewComponentConfig() {\n        this.transclude = false;\n        this.template = template;\n        this.controller = KindViewController;\n        this.controllerAs = 'vm';\n    }\n    return KindViewComponentConfig;\n}());\nexports.KindViewComponentConfig = KindViewComponentConfig;\nvar KindViewController = /** @class */ (function (_super) {\n    __extends(KindViewController, _super);\n    /* @ngInject */\n    function KindViewController($stateParams, gesuchModelManager, berechnungsManager, CONSTANTS, $scope, errorService, wizardStepManager, $q, $translate, $timeout) {\n        var _this = _super.call(this, gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName_1.TSWizardStepName.KINDER, $timeout) || this;\n        _this.CONSTANTS = CONSTANTS;\n        _this.errorService = errorService;\n        _this.$q = $q;\n        _this.$translate = $translate;\n        if ($stateParams.kindNumber) {\n            var kindIndex = _this.gesuchModelManager.convertKindNumberToKindIndex(parseInt($stateParams.kindNumber));\n            if (kindIndex >= 0) {\n                _this.model = angular.copy(_this.gesuchModelManager.getGesuch().kindContainers[kindIndex]);\n                _this.gesuchModelManager.setKindIndex(kindIndex);\n            }\n        }\n        else {\n            //wenn kind nummer nicht definiert ist heisst dass, das wir ein neues erstellen sollten\n            _this.model = _this.initEmptyKind(undefined);\n            var kindIndex = _this.gesuchModelManager.getGesuch().kindContainers ? _this.gesuchModelManager.getGesuch().kindContainers.length : 0;\n            _this.gesuchModelManager.setKindIndex(kindIndex);\n        }\n        _this.initViewModel();\n        _this.allowedRoles = _this.TSRoleUtil.getAllRolesButTraegerschaftInstitution();\n        return _this;\n    }\n    KindViewController.prototype.initViewModel = function () {\n        this.geschlechter = EnumEx_1.EnumEx.getNames(TSGeschlecht_1.TSGeschlecht);\n        this.kinderabzugValues = TSKinderabzug_1.getTSKinderabzugValues();\n        this.showFachstelle = (this.model.kindJA.pensumFachstelle) ? true : false;\n        this.showFachstelleGS = (this.model.kindGS && this.model.kindGS.pensumFachstelle) ? true : false;\n        if (this.getPensumFachstelle() && this.getPensumFachstelle().fachstelle) {\n            this.fachstelleId = this.getPensumFachstelle().fachstelle.id;\n        }\n        if (!this.gesuchModelManager.getFachstellenList() || this.gesuchModelManager.getFachstellenList().length <= 0) {\n            this.gesuchModelManager.updateFachstellenList();\n        }\n    };\n    KindViewController.prototype.save = function () {\n        if (this.isGesuchValid()) {\n            if (!this.form.$dirty) {\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.model);\n            }\n            this.errorService.clearAll();\n            return this.gesuchModelManager.saveKind(this.model);\n        }\n        return undefined;\n    };\n    KindViewController.prototype.cancel = function () {\n        this.reset();\n        this.form.$setPristine();\n    };\n    KindViewController.prototype.reset = function () {\n        this.removeKindFromList();\n    };\n    KindViewController.prototype.removeKindFromList = function () {\n        if (!this.model.timestampErstellt) {\n            //wenn das Kind noch nicht erstellt wurde, löschen wir das Kind vom Array\n            this.gesuchModelManager.removeKindFromList();\n        }\n    };\n    KindViewController.prototype.setSelectedFachsstelle = function () {\n        var fachstellenList = this.getFachstellenList();\n        for (var i = 0; i < fachstellenList.length; i++) {\n            if (fachstellenList[i].id === this.fachstelleId) {\n                this.getModel().pensumFachstelle.fachstelle = fachstellenList[i];\n            }\n        }\n    };\n    KindViewController.prototype.showFachstelleClicked = function () {\n        if (!this.showFachstelle) {\n            this.resetFachstelleFields();\n        }\n        else {\n            this.getModel().pensumFachstelle = new TSPensumFachstelle_1.TSPensumFachstelle();\n        }\n    };\n    KindViewController.prototype.familienErgaenzendeBetreuungClicked = function () {\n        if (!this.getModel().familienErgaenzendeBetreuung) {\n            this.showFachstelle = false;\n            this.getModel().wohnhaftImGleichenHaushalt = undefined;\n            this.resetFachstelleFields();\n        }\n    };\n    KindViewController.prototype.resetFachstelleFields = function () {\n        this.fachstelleId = undefined;\n        this.getModel().pensumFachstelle = undefined;\n    };\n    KindViewController.prototype.getFachstellenList = function () {\n        return this.gesuchModelManager.getFachstellenList();\n    };\n    KindViewController.prototype.getModel = function () {\n        if (this.model) {\n            return this.model.kindJA;\n        }\n        return undefined;\n    };\n    KindViewController.prototype.getContainer = function () {\n        if (this.model) {\n            return this.model;\n        }\n        return undefined;\n    };\n    KindViewController.prototype.getPensumFachstelle = function () {\n        if (this.getModel()) {\n            return this.getModel().pensumFachstelle;\n        }\n        return undefined;\n    };\n    KindViewController.prototype.isFachstelleRequired = function () {\n        return this.getModel() && this.getModel().familienErgaenzendeBetreuung && this.showFachstelle;\n    };\n    KindViewController.prototype.getDatumEinschulung = function () {\n        return this.gesuchModelManager.getGesuchsperiodeBegin();\n    };\n    KindViewController.prototype.getTextFachstelleKorrekturJA = function () {\n        if (this.getContainer().kindGS && this.getContainer().kindGS.pensumFachstelle) {\n            var fachstelle = this.getContainer().kindGS.pensumFachstelle;\n            var vonText = DateUtil_1.default.momentToLocalDateFormat(fachstelle.gueltigkeit.gueltigAb, 'DD.MM.YYYY');\n            var bisText = fachstelle.gueltigkeit.gueltigBis ? DateUtil_1.default.momentToLocalDateFormat(fachstelle.gueltigkeit.gueltigBis, 'DD.MM.YYYY') : '31.12.9999';\n            return this.$translate.instant('JA_KORREKTUR_FACHSTELLE', {\n                name: fachstelle.fachstelle.name,\n                pensum: fachstelle.pensum,\n                von: vonText,\n                bis: bisText\n            });\n        }\n        else {\n            return this.$translate.instant('LABEL_KEINE_ANGABE');\n        }\n    };\n    KindViewController.prototype.initEmptyKind = function (kindNumber) {\n        var tsKindContainer = new TSKindContainer_1.default(undefined, new TSKind_1.default());\n        tsKindContainer.kindNummer = kindNumber;\n        return tsKindContainer;\n    };\n    /**\n     * Returns true if the Kind has a Betreuung\n     */\n    KindViewController.prototype.hasKindBetreuungen = function () {\n        return this.model.betreuungen && this.model.betreuungen.length > 0;\n    };\n    KindViewController.$inject = ['$stateParams', 'GesuchModelManager', 'BerechnungsManager', 'CONSTANTS', '$scope',\n        'ErrorService', 'WizardStepManager', '$q', '$translate', '$timeout'];\n    return KindViewController;\n}(abstractGesuchView_1.default));\nexports.KindViewController = KindViewController;\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/kindView/kindView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/kindView/kindView.ts"],"names":[],"mappings":";AAAA;;;;;;;;;;;;;GAaG;;;;;;;;;;;;AAKH,iDAA4C;AAC5C,gDAA6C;AAC7C,mEAAgE;AAChE,4DAAiE;AACjE,yEAAsE;AAEtE,mEAA8D;AAC9D,qEAA0F;AAI1F,oDAA+C;AAC/C,2EAAwE;AAQxE,IAAI,QAAQ,GAAG,OAAO,CAAC,iBAAiB,CAAC,CAAC;AAC1C,OAAO,CAAC,iBAAiB,CAAC,CAAC;AAE3B;IAAA;QACI,eAAU,GAAG,KAAK,CAAC;QACnB,aAAQ,GAAG,QAAQ,CAAC;QACpB,eAAU,GAAG,kBAAkB,CAAC;QAChC,iBAAY,GAAG,IAAI,CAAC;IACxB,CAAC;IAAD,8BAAC;AAAD,CAAC,AALD,IAKC;AALY,0DAAuB;AAOpC;IAAwC,sCAA6C;IAWjF,eAAe;IACf,4BAAY,YAA8B,EAAE,kBAAsC,EACtE,kBAAsC,EAAU,SAAc,EAAE,MAAc,EAAU,YAA0B,EAClH,iBAAoC,EAAU,EAAa,EAAU,UAA6B,EAAE,QAAyB;QAFzI,YAGI,kBAAM,kBAAkB,EAAE,kBAAkB,EAAE,iBAAiB,EAAE,MAAM,EAAE,mCAAgB,CAAC,MAAM,EAAE,QAAQ,CAAC,SAe9G;QAjB2D,eAAS,GAAT,SAAS,CAAK;QAA0B,kBAAY,GAAZ,YAAY,CAAc;QACpE,QAAE,GAAF,EAAE,CAAW;QAAU,gBAAU,GAAV,UAAU,CAAmB;QAE1G,EAAE,CAAC,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC,CAAC;YAC1B,IAAI,SAAS,GAAW,KAAI,CAAC,kBAAkB,CAAC,4BAA4B,CAAC,QAAQ,CAAC,YAAY,CAAC,UAAU,CAAC,CAAC,CAAC;YAChH,EAAE,CAAC,CAAC,SAAS,IAAI,CAAC,CAAC,CAAC,CAAC;gBACjB,KAAI,CAAC,KAAK,GAAG,OAAO,CAAC,IAAI,CAAC,KAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,CAAC,cAAc,CAAC,SAAS,CAAC,CAAC,CAAC;gBACzF,KAAI,CAAC,kBAAkB,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;YACpD,CAAC;QACL,CAAC;QAAC,IAAI,CAAC,CAAC;YACJ,uFAAuF;YACvF,KAAI,CAAC,KAAK,GAAG,KAAI,CAAC,aAAa,CAAC,SAAS,CAAC,CAAC;YAC3C,IAAI,SAAS,GAAW,KAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,CAAC,cAAc,CAAC,CAAC,CAAC,KAAI,CAAC,kBAAkB,CAAC,SAAS,EAAE,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC;YAC3I,KAAI,CAAC,kBAAkB,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;QACpD,CAAC;QACD,KAAI,CAAC,aAAa,EAAE,CAAC;QACrB,KAAI,CAAC,YAAY,GAAG,KAAI,CAAC,UAAU,CAAC,sCAAsC,EAAE,CAAC;;IACjF,CAAC;IAEO,0CAAa,GAArB;QACI,IAAI,CAAC,YAAY,GAAG,eAAM,CAAC,QAAQ,CAAC,2BAAY,CAAC,CAAC;QAClD,IAAI,CAAC,iBAAiB,GAAG,sCAAsB,EAAE,CAAC;QAClD,IAAI,CAAC,cAAc,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC;QAC1E,IAAI,CAAC,gBAAgB,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC;QACjG,EAAE,CAAC,CAAC,IAAI,CAAC,mBAAmB,EAAE,IAAI,IAAI,CAAC,mBAAmB,EAAE,CAAC,UAAU,CAAC,CAAC,CAAC;YACtE,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC,UAAU,CAAC,EAAE,CAAC;QACjE,CAAC;QACD,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,kBAAkB,EAAE,IAAI,IAAI,CAAC,kBAAkB,CAAC,kBAAkB,EAAE,CAAC,MAAM,IAAI,CAAC,CAAC,CAAC,CAAC;YAC5G,IAAI,CAAC,kBAAkB,CAAC,qBAAqB,EAAE,CAAC;QACpD,CAAC;IACL,CAAC;IAED,iCAAI,GAAJ;QACI,EAAE,CAAC,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,CAAC,CAAC;YACvB,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC;gBACpB,qGAAqG;gBACrG,sBAAsB;gBACtB,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACpC,CAAC;YAED,IAAI,CAAC,YAAY,CAAC,QAAQ,EAAE,CAAC;YAC7B,MAAM,CAAC,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QACxD,CAAC;QACD,MAAM,CAAC,SAAS,CAAC;IACrB,CAAC;IAED,mCAAM,GAAN;QACI,IAAI,CAAC,KAAK,EAAE,CAAC;QACb,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC;IAC7B,CAAC;IAED,kCAAK,GAAL;QACI,IAAI,CAAC,kBAAkB,EAAE,CAAC;IAC9B,CAAC;IAEO,+CAAkB,GAA1B;QACI,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,iBAAiB,CAAC,CAAC,CAAC;YAChC,yEAAyE;YACzE,IAAI,CAAC,kBAAkB,CAAC,kBAAkB,EAAE,CAAC;QACjD,CAAC;IACL,CAAC;IAEM,mDAAsB,GAA7B;QACI,IAAI,eAAe,GAAG,IAAI,CAAC,kBAAkB,EAAE,CAAC;QAChD,GAAG,CAAC,CAAC,IAAI,CAAC,GAAW,CAAC,EAAE,CAAC,GAAG,eAAe,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACtD,EAAE,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC,EAAE,KAAK,IAAI,CAAC,YAAY,CAAC,CAAC,CAAC;gBAC9C,IAAI,CAAC,QAAQ,EAAE,CAAC,gBAAgB,CAAC,UAAU,GAAG,eAAe,CAAC,CAAC,CAAC,CAAC;YACrE,CAAC;QACL,CAAC;IACL,CAAC;IAEM,kDAAqB,GAA5B;QACI,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,cAAc,CAAC,CAAC,CAAC;YACvB,IAAI,CAAC,qBAAqB,EAAE,CAAC;QACjC,CAAC;QAAC,IAAI,CAAC,CAAC;YACJ,IAAI,CAAC,QAAQ,EAAE,CAAC,gBAAgB,GAAG,IAAI,uCAAkB,EAAE,CAAC;QAChE,CAAC;IACL,CAAC;IAEM,gEAAmC,GAA1C;QACI,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,4BAA4B,CAAC,CAAC,CAAC;YAChD,IAAI,CAAC,cAAc,GAAG,KAAK,CAAC;YAC5B,IAAI,CAAC,QAAQ,EAAE,CAAC,0BAA0B,GAAG,SAAS,CAAC;YACvD,IAAI,CAAC,qBAAqB,EAAE,CAAC;QACjC,CAAC;IACL,CAAC;IAEO,kDAAqB,GAA7B;QACI,IAAI,CAAC,YAAY,GAAG,SAAS,CAAC;QAC9B,IAAI,CAAC,QAAQ,EAAE,CAAC,gBAAgB,GAAG,SAAS,CAAC;IACjD,CAAC;IAEM,+CAAkB,GAAzB;QACI,MAAM,CAAC,IAAI,CAAC,kBAAkB,CAAC,kBAAkB,EAAE,CAAC;IACxD,CAAC;IAEM,qCAAQ,GAAf;QACI,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC;YACb,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;QAC7B,CAAC;QACD,MAAM,CAAC,SAAS,CAAC;IACrB,CAAC;IAEM,yCAAY,GAAnB;QACI,EAAE,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC;YACb,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC;QACtB,CAAC;QACD,MAAM,CAAC,SAAS,CAAC;IACrB,CAAC;IAEM,gDAAmB,GAA1B;QACI,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC;YAClB,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,gBAAgB,CAAC;QAC5C,CAAC;QACD,MAAM,CAAC,SAAS,CAAC;IACrB,CAAC;IAEM,iDAAoB,GAA3B;QACI,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC,4BAA4B,IAAI,IAAI,CAAC,cAAc,CAAC;IAClG,CAAC;IAEM,gDAAmB,GAA1B;QACI,MAAM,CAAC,IAAI,CAAC,kBAAkB,CAAC,sBAAsB,EAAE,CAAC;IAC5D,CAAC;IAEM,yDAA4B,GAAnC;QACI,EAAE,CAAC,CAAC,IAAI,CAAC,YAAY,EAAE,CAAC,MAAM,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC,MAAM,CAAC,gBAAgB,CAAC,CAAC,CAAC;YAC5E,IAAI,UAAU,GAAuB,IAAI,CAAC,YAAY,EAAE,CAAC,MAAM,CAAC,gBAAgB,CAAC;YACjF,IAAI,OAAO,GAAG,kBAAQ,CAAC,uBAAuB,CAAC,UAAU,CAAC,WAAW,CAAC,SAAS,EAAE,YAAY,CAAC,CAAC;YAC/F,IAAI,OAAO,GAAG,UAAU,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC,CAAC,kBAAQ,CAAC,uBAAuB,CAAC,UAAU,CAAC,WAAW,CAAC,UAAU,EAAE,YAAY,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC;YACnJ,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,yBAAyB,EAAE;gBACtD,IAAI,EAAE,UAAU,CAAC,UAAU,CAAC,IAAI;gBAChC,MAAM,EAAE,UAAU,CAAC,MAAM;gBACzB,GAAG,EAAE,OAAO;gBACZ,GAAG,EAAE,OAAO;aACf,CAAC,CAAC;QACP,CAAC;QAAC,IAAI,CAAC,CAAC;YACJ,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,oBAAoB,CAAC,CAAC;QACzD,CAAC;IACL,CAAC;IAEO,0CAAa,GAArB,UAAsB,UAAkB;QACpC,IAAI,eAAe,GAAG,IAAI,yBAAe,CAAC,SAAS,EAAE,IAAI,gBAAM,EAAE,CAAC,CAAC;QACnE,eAAe,CAAC,UAAU,GAAG,UAAU,CAAC;QACxC,MAAM,CAAC,eAAe,CAAC;IAC3B,CAAC;IAED;;OAEG;IACI,+CAAkB,GAAzB;QACI,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,WAAW,IAAI,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,MAAM,GAAG,CAAC,CAAC;IACvE,CAAC;IA7JM,0BAAO,GAAa,CAAC,cAAc,EAAE,oBAAoB,EAAE,oBAAoB,EAAE,WAAW,EAAE,QAAQ;QACzG,cAAc,EAAE,mBAAmB,EAAE,IAAI,EAAE,YAAY,EAAE,UAAU,CAAC,CAAC;IA6J7E,yBAAC;CAAA,AAtKD,CAAwC,4BAA4B,GAsKnE;AAtKY,gDAAkB","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {IComponentOptions} from 'angular';\nimport {IKindStateParams} from '../../gesuch.route';\nimport GesuchModelManager from '../../service/gesuchModelManager';\nimport TSKind from '../../../models/TSKind';\nimport {EnumEx} from '../../../utils/EnumEx';\nimport {TSGeschlecht} from '../../../models/enums/TSGeschlecht';\nimport AbstractGesuchViewController from '../abstractGesuchView';\nimport {TSPensumFachstelle} from '../../../models/TSPensumFachstelle';\nimport BerechnungsManager from '../../service/berechnungsManager';\nimport TSKindContainer from '../../../models/TSKindContainer';\nimport {getTSKinderabzugValues, TSKinderabzug} from '../../../models/enums/TSKinderabzug';\nimport ErrorService from '../../../core/errors/service/ErrorService';\nimport WizardStepManager from '../../service/wizardStepManager';\nimport {TSRole} from '../../../models/enums/TSRole';\nimport DateUtil from '../../../utils/DateUtil';\nimport {TSWizardStepName} from '../../../models/enums/TSWizardStepName';\nimport * as moment from 'moment';\nimport IPromise = angular.IPromise;\nimport IQService = angular.IQService;\nimport ITranslateService = angular.translate.ITranslateService;\nimport ITimeoutService = angular.ITimeoutService;\nimport IScope = angular.IScope;\n\nlet template = require('./kindView.html');\nrequire('./kindView.less');\n\nexport class KindViewComponentConfig implements IComponentOptions {\n    transclude = false;\n    template = template;\n    controller = KindViewController;\n    controllerAs = 'vm';\n}\n\nexport class KindViewController extends AbstractGesuchViewController<TSKindContainer> {\n    geschlechter: Array<string>;\n    kinderabzugValues: Array<TSKinderabzug>;\n    showFachstelle: boolean;\n    showFachstelleGS: boolean;\n    fachstelleId: string; //der ausgewaehlte fachstelleId wird hier gespeichert und dann in die entsprechende Fachstelle umgewandert\n    allowedRoles: Array<TSRole>;\n\n    static $inject: string[] = ['$stateParams', 'GesuchModelManager', 'BerechnungsManager', 'CONSTANTS', '$scope',\n        'ErrorService', 'WizardStepManager', '$q', '$translate', '$timeout'];\n\n    /* @ngInject */\n    constructor($stateParams: IKindStateParams, gesuchModelManager: GesuchModelManager,\n                berechnungsManager: BerechnungsManager, private CONSTANTS: any, $scope: IScope, private errorService: ErrorService,\n                wizardStepManager: WizardStepManager, private $q: IQService, private $translate: ITranslateService, $timeout: ITimeoutService) {\n        super(gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName.KINDER, $timeout);\n        if ($stateParams.kindNumber) {\n            let kindIndex: number = this.gesuchModelManager.convertKindNumberToKindIndex(parseInt($stateParams.kindNumber));\n            if (kindIndex >= 0) {\n                this.model = angular.copy(this.gesuchModelManager.getGesuch().kindContainers[kindIndex]);\n                this.gesuchModelManager.setKindIndex(kindIndex);\n            }\n        } else {\n            //wenn kind nummer nicht definiert ist heisst dass, das wir ein neues erstellen sollten\n            this.model = this.initEmptyKind(undefined);\n            let kindIndex: number = this.gesuchModelManager.getGesuch().kindContainers ? this.gesuchModelManager.getGesuch().kindContainers.length : 0;\n            this.gesuchModelManager.setKindIndex(kindIndex);\n        }\n        this.initViewModel();\n        this.allowedRoles = this.TSRoleUtil.getAllRolesButTraegerschaftInstitution();\n    }\n\n    private initViewModel(): void {\n        this.geschlechter = EnumEx.getNames(TSGeschlecht);\n        this.kinderabzugValues = getTSKinderabzugValues();\n        this.showFachstelle = (this.model.kindJA.pensumFachstelle) ? true : false;\n        this.showFachstelleGS = (this.model.kindGS && this.model.kindGS.pensumFachstelle) ? true : false;\n        if (this.getPensumFachstelle() && this.getPensumFachstelle().fachstelle) {\n            this.fachstelleId = this.getPensumFachstelle().fachstelle.id;\n        }\n        if (!this.gesuchModelManager.getFachstellenList() || this.gesuchModelManager.getFachstellenList().length <= 0) {\n            this.gesuchModelManager.updateFachstellenList();\n        }\n    }\n\n    save(): IPromise<TSKindContainer> {\n        if (this.isGesuchValid()) {\n            if (!this.form.$dirty) {\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.model);\n            }\n\n            this.errorService.clearAll();\n            return this.gesuchModelManager.saveKind(this.model);\n        }\n        return undefined;\n    }\n\n    cancel() {\n        this.reset();\n        this.form.$setPristine();\n    }\n\n    reset() {\n        this.removeKindFromList();\n    }\n\n    private removeKindFromList() {\n        if (!this.model.timestampErstellt) {\n            //wenn das Kind noch nicht erstellt wurde, löschen wir das Kind vom Array\n            this.gesuchModelManager.removeKindFromList();\n        }\n    }\n\n    public setSelectedFachsstelle() {\n        let fachstellenList = this.getFachstellenList();\n        for (let i: number = 0; i < fachstellenList.length; i++) {\n            if (fachstellenList[i].id === this.fachstelleId) {\n                this.getModel().pensumFachstelle.fachstelle = fachstellenList[i];\n            }\n        }\n    }\n\n    public showFachstelleClicked() {\n        if (!this.showFachstelle) {\n            this.resetFachstelleFields();\n        } else {\n            this.getModel().pensumFachstelle = new TSPensumFachstelle();\n        }\n    }\n\n    public familienErgaenzendeBetreuungClicked() {\n        if (!this.getModel().familienErgaenzendeBetreuung) {\n            this.showFachstelle = false;\n            this.getModel().wohnhaftImGleichenHaushalt = undefined;\n            this.resetFachstelleFields();\n        }\n    }\n\n    private resetFachstelleFields() {\n        this.fachstelleId = undefined;\n        this.getModel().pensumFachstelle = undefined;\n    }\n\n    public getFachstellenList() {\n        return this.gesuchModelManager.getFachstellenList();\n    }\n\n    public getModel(): TSKind {\n        if (this.model) {\n            return this.model.kindJA;\n        }\n        return undefined;\n    }\n\n    public getContainer(): TSKindContainer {\n        if (this.model) {\n            return this.model;\n        }\n        return undefined;\n    }\n\n    public getPensumFachstelle(): TSPensumFachstelle {\n        if (this.getModel()) {\n            return this.getModel().pensumFachstelle;\n        }\n        return undefined;\n    }\n\n    public isFachstelleRequired(): boolean {\n        return this.getModel() && this.getModel().familienErgaenzendeBetreuung && this.showFachstelle;\n    }\n\n    public getDatumEinschulung(): moment.Moment {\n        return this.gesuchModelManager.getGesuchsperiodeBegin();\n    }\n\n    public getTextFachstelleKorrekturJA(): string {\n        if (this.getContainer().kindGS && this.getContainer().kindGS.pensumFachstelle) {\n            let fachstelle: TSPensumFachstelle = this.getContainer().kindGS.pensumFachstelle;\n            let vonText = DateUtil.momentToLocalDateFormat(fachstelle.gueltigkeit.gueltigAb, 'DD.MM.YYYY');\n            let bisText = fachstelle.gueltigkeit.gueltigBis ? DateUtil.momentToLocalDateFormat(fachstelle.gueltigkeit.gueltigBis, 'DD.MM.YYYY') : '31.12.9999';\n            return this.$translate.instant('JA_KORREKTUR_FACHSTELLE', {\n                name: fachstelle.fachstelle.name,\n                pensum: fachstelle.pensum,\n                von: vonText,\n                bis: bisText\n            });\n        } else {\n            return this.$translate.instant('LABEL_KEINE_ANGABE');\n        }\n    }\n\n    private initEmptyKind(kindNumber: number): TSKindContainer {\n        let tsKindContainer = new TSKindContainer(undefined, new TSKind());\n        tsKindContainer.kindNummer = kindNumber;\n        return tsKindContainer;\n    }\n\n    /**\n     * Returns true if the Kind has a Betreuung\n     */\n    public hasKindBetreuungen(): boolean {\n        return this.model.betreuungen && this.model.betreuungen.length > 0;\n    }\n}\n\n"]}]}
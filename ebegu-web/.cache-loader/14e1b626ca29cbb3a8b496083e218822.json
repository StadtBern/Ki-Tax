{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/erwerbspensumView/erwerbspensumView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/erwerbspensumView/erwerbspensumView.ts","mtime":1518535855224},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\ndefine([\"require\", \"exports\", \"../abstractGesuchView\", \"../../../models/TSErwerbspensumContainer\", \"../../../models/enums/TSTaetigkeit\", \"../../../models/enums/TSZuschlagsgrund\", \"../../../models/TSErwerbspensum\", \"../../../utils/TSRoleUtil\", \"../../../models/enums/TSWizardStepName\", \"../../../models/enums/TSEbeguParameterKey\", \"../../../models/enums/TSCacheTyp\"], function (require, exports, abstractGesuchView_1, TSErwerbspensumContainer_1, TSTaetigkeit_1, TSZuschlagsgrund_1, TSErwerbspensum_1, TSRoleUtil_1, TSWizardStepName_1, TSEbeguParameterKey_1, TSCacheTyp_1) {\n    \"use strict\";\n    Object.defineProperty(exports, \"__esModule\", { value: true });\n    var template = require('./erwerbspensumView.html');\n    require('./erwerbspensumView.less');\n    var ErwerbspensumViewComponentConfig = /** @class */ (function () {\n        function ErwerbspensumViewComponentConfig() {\n            this.transclude = false;\n            this.bindings = {};\n            this.template = template;\n            this.controller = ErwerbspensumViewController;\n            this.controllerAs = 'vm';\n        }\n        return ErwerbspensumViewComponentConfig;\n    }());\n    exports.ErwerbspensumViewComponentConfig = ErwerbspensumViewComponentConfig;\n    var ErwerbspensumViewController = /** @class */ (function (_super) {\n        __extends(ErwerbspensumViewController, _super);\n        /* @ngInject */\n        function ErwerbspensumViewController($stateParams, gesuchModelManager, berechnungsManager, CONSTANTS, $scope, errorService, authServiceRS, wizardStepManager, $q, $translate, ebeguParameterRS, globalCacheService, $timeout) {\n            var _this = _super.call(this, gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName_1.TSWizardStepName.ERWERBSPENSUM, $timeout) || this;\n            _this.CONSTANTS = CONSTANTS;\n            _this.errorService = errorService;\n            _this.authServiceRS = authServiceRS;\n            _this.$q = $q;\n            _this.$translate = $translate;\n            _this.ebeguParameterRS = ebeguParameterRS;\n            _this.globalCacheService = globalCacheService;\n            _this.maxZuschlagsprozent = 100;\n            _this.patternPercentage = _this.CONSTANTS.PATTERN_PERCENTAGE;\n            _this.gesuchModelManager.setGesuchstellerNumber(parseInt($stateParams.gesuchstellerNumber));\n            _this.gesuchsteller = _this.gesuchModelManager.getStammdatenToWorkWith();\n            if (_this.gesuchsteller) {\n                if ($stateParams.erwerbspensumNum) {\n                    var ewpNum = parseInt($stateParams.erwerbspensumNum) | 0;\n                    _this.model = angular.copy(_this.gesuchsteller.erwerbspensenContainer[ewpNum]);\n                }\n                else {\n                    //wenn erwerbspensum nummer nicht definiert ist heisst dass, das wir ein neues erstellen sollten\n                    _this.model = _this.initEmptyEwpContainer();\n                }\n            }\n            else {\n                errorService.addMesageAsError('Unerwarteter Zustand: Gesuchsteller unbekannt');\n                console.log('kein gesuchsteller gefunden');\n            }\n            ebeguParameterRS.getEbeguParameterByGesuchsperiodeCached(_this.gesuchModelManager.getGesuchsperiode().id, _this.globalCacheService.getCache(TSCacheTyp_1.TSCacheTyp.EBEGU_PARAMETER)).then(function (response) {\n                for (var i = 0; i < response.length; i++) {\n                    if (response[i].name === TSEbeguParameterKey_1.TSEbeguParameterKey.PARAM_MAXIMALER_ZUSCHLAG_ERWERBSPENSUM) {\n                        // max Wert für Zuschlag Erwerbspensum\n                        _this.maxZuschlagsprozent = Number(response[i].value);\n                    }\n                }\n            });\n            return _this;\n        }\n        ErwerbspensumViewController.prototype.getTaetigkeitenList = function () {\n            return TSTaetigkeit_1.getTSTaetigkeit();\n        };\n        ErwerbspensumViewController.prototype.getZuschlagsgrundList = function () {\n            if (this.authServiceRS.isOneOfRoles(TSRoleUtil_1.TSRoleUtil.getGesuchstellerOnlyRoles())) {\n                return TSZuschlagsgrund_1.getTSZuschlagsgruendeForGS();\n            }\n            else {\n                return TSZuschlagsgrund_1.getTSZuschlagsgrunde();\n            }\n        };\n        /**\n         * Beim speichern wird geschaut ob Zuschlagsgrund noetig ist, wenn nicht zuruecksetzten\n         * @param erwerbspensum\n         */\n        ErwerbspensumViewController.prototype.maybeResetZuschlagsgrund = function (erwerbspensum) {\n            if (erwerbspensum && !erwerbspensum.erwerbspensumJA.zuschlagZuErwerbspensum) {\n                erwerbspensum.erwerbspensumJA.zuschlagsprozent = undefined;\n                erwerbspensum.erwerbspensumJA.zuschlagsgrund = undefined;\n            }\n        };\n        ErwerbspensumViewController.prototype.save = function () {\n            if (this.isGesuchValid()) {\n                if (!this.form.$dirty) {\n                    // If there are no changes in form we don't need anything to update on Server and we could return the\n                    // promise immediately\n                    return this.$q.when(this.model);\n                }\n                this.maybeResetZuschlagsgrund(this.model);\n                this.errorService.clearAll();\n                return this.gesuchModelManager.saveErwerbspensum(this.gesuchsteller, this.model);\n            }\n            return undefined;\n        };\n        ErwerbspensumViewController.prototype.cancel = function () {\n            this.form.$setPristine();\n        };\n        ErwerbspensumViewController.prototype.initEmptyEwpContainer = function () {\n            var ewp = new TSErwerbspensum_1.default();\n            var ewpContainer = new TSErwerbspensumContainer_1.default();\n            ewpContainer.erwerbspensumJA = ewp;\n            return ewpContainer;\n        };\n        ErwerbspensumViewController.prototype.viewZuschlag = function () {\n            return this.model.erwerbspensumJA.taetigkeit === TSTaetigkeit_1.TSTaetigkeit.ANGESTELLT ||\n                this.model.erwerbspensumJA.taetigkeit === TSTaetigkeit_1.TSTaetigkeit.AUSBILDUNG ||\n                this.model.erwerbspensumJA.taetigkeit === TSTaetigkeit_1.TSTaetigkeit.SELBSTAENDIG;\n        };\n        ErwerbspensumViewController.prototype.taetigkeitChanged = function () {\n            if (!this.viewZuschlag()) {\n                this.model.erwerbspensumJA.zuschlagZuErwerbspensum = false;\n                this.model.erwerbspensumJA.zuschlagsprozent = undefined;\n                this.model.erwerbspensumJA.zuschlagsgrund = undefined;\n            }\n        };\n        ErwerbspensumViewController.prototype.erwerbspensumDisabled = function () {\n            // Disabled wenn Mutation, ausser bei Bearbeiter Jugendamt\n            return this.model.erwerbspensumJA.vorgaengerId && !this.authServiceRS.isOneOfRoles(TSRoleUtil_1.TSRoleUtil.getAdministratorJugendamtRole());\n        };\n        ErwerbspensumViewController.prototype.getTextZuschlagErwerbspensumKorrekturJA = function () {\n            if (this.model.erwerbspensumGS && this.model.erwerbspensumGS.zuschlagZuErwerbspensum === true) {\n                var ewp = this.model.erwerbspensumGS;\n                var grundText = this.$translate.instant(ewp.zuschlagsgrund.toString());\n                return this.$translate.instant('JA_KORREKTUR_ZUSCHLAG_ERWERBSPENSUM', {\n                    zuschlagsgrund: grundText,\n                    zuschlagsprozent: ewp.zuschlagsprozent\n                });\n            }\n            else {\n                return this.$translate.instant('LABEL_KEINE_ANGABE');\n            }\n        };\n        ErwerbspensumViewController.prototype.getZuschlagHelpText = function () {\n            return this.$translate.instant('ZUSCHLAGSGRUND_HELP', {\n                maxzuschlag: this.maxZuschlagsprozent\n            });\n        };\n        ErwerbspensumViewController.$inject = ['$stateParams', 'GesuchModelManager', 'BerechnungsManager',\n            'CONSTANTS', '$scope', 'ErrorService', 'AuthServiceRS', 'WizardStepManager', '$q', '$translate', 'EbeguParameterRS', 'GlobalCacheService', '$timeout'];\n        return ErwerbspensumViewController;\n    }(abstractGesuchView_1.default));\n    exports.ErwerbspensumViewController = ErwerbspensumViewController;\n});\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/erwerbspensumView/erwerbspensumView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/erwerbspensumView/erwerbspensumView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {IComponentOptions, IPromise, IQService, IScope, ITimeoutService} from 'angular';\nimport AbstractGesuchViewController from '../abstractGesuchView';\nimport GesuchModelManager from '../../service/gesuchModelManager';\nimport {IErwerbspensumStateParams} from '../../gesuch.route';\nimport TSErwerbspensumContainer from '../../../models/TSErwerbspensumContainer';\nimport {getTSTaetigkeit, TSTaetigkeit} from '../../../models/enums/TSTaetigkeit';\nimport {getTSZuschlagsgruendeForGS, getTSZuschlagsgrunde, TSZuschlagsgrund} from '../../../models/enums/TSZuschlagsgrund';\nimport TSErwerbspensum from '../../../models/TSErwerbspensum';\nimport BerechnungsManager from '../../service/berechnungsManager';\nimport ErrorService from '../../../core/errors/service/ErrorService';\nimport AuthServiceRS from '../../../authentication/service/AuthServiceRS.rest';\nimport WizardStepManager from '../../service/wizardStepManager';\nimport {TSRoleUtil} from '../../../utils/TSRoleUtil';\nimport TSGesuchstellerContainer from '../../../models/TSGesuchstellerContainer';\nimport {TSWizardStepName} from '../../../models/enums/TSWizardStepName';\nimport TSEbeguParameter from '../../../models/TSEbeguParameter';\nimport {TSEbeguParameterKey} from '../../../models/enums/TSEbeguParameterKey';\nimport GlobalCacheService from '../../service/globalCacheService';\nimport {EbeguParameterRS} from '../../../admin/service/ebeguParameterRS.rest';\nimport {TSCacheTyp} from '../../../models/enums/TSCacheTyp';\nimport ITranslateService = angular.translate.ITranslateService;\n\nlet template: string = require('./erwerbspensumView.html');\nrequire('./erwerbspensumView.less');\n\nexport class ErwerbspensumViewComponentConfig implements IComponentOptions {\n    transclude: boolean;\n    bindings: any;\n    template: string;\n    controller: any;\n    controllerAs: string;\n\n    constructor() {\n        this.transclude = false;\n        this.bindings = {};\n        this.template = template;\n        this.controller = ErwerbspensumViewController;\n        this.controllerAs = 'vm';\n    }\n}\n\nexport class ErwerbspensumViewController extends AbstractGesuchViewController<TSErwerbspensumContainer> {\n\n    gesuchsteller: TSGesuchstellerContainer;\n    patternPercentage: string;\n    maxZuschlagsprozent: number = 100;\n\n    static $inject: string[] = ['$stateParams', 'GesuchModelManager', 'BerechnungsManager',\n        'CONSTANTS', '$scope', 'ErrorService', 'AuthServiceRS', 'WizardStepManager', '$q', '$translate', 'EbeguParameterRS', 'GlobalCacheService', '$timeout'];\n\n    /* @ngInject */\n    constructor($stateParams: IErwerbspensumStateParams, gesuchModelManager: GesuchModelManager,\n                berechnungsManager: BerechnungsManager, private CONSTANTS: any, $scope: IScope, private errorService: ErrorService,\n                private authServiceRS: AuthServiceRS, wizardStepManager: WizardStepManager, private $q: IQService,\n                private $translate: ITranslateService, private ebeguParameterRS: EbeguParameterRS, private globalCacheService: GlobalCacheService,\n                $timeout: ITimeoutService) {\n        super(gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName.ERWERBSPENSUM, $timeout);\n        this.patternPercentage = this.CONSTANTS.PATTERN_PERCENTAGE;\n        this.gesuchModelManager.setGesuchstellerNumber(parseInt($stateParams.gesuchstellerNumber));\n        this.gesuchsteller = this.gesuchModelManager.getStammdatenToWorkWith();\n        if (this.gesuchsteller) {\n            if ($stateParams.erwerbspensumNum) {\n                let ewpNum = parseInt($stateParams.erwerbspensumNum) | 0;\n                this.model = angular.copy(this.gesuchsteller.erwerbspensenContainer[ewpNum]);\n            } else {\n                //wenn erwerbspensum nummer nicht definiert ist heisst dass, das wir ein neues erstellen sollten\n                this.model = this.initEmptyEwpContainer();\n            }\n        } else {\n            errorService.addMesageAsError('Unerwarteter Zustand: Gesuchsteller unbekannt');\n            console.log('kein gesuchsteller gefunden');\n        }\n        ebeguParameterRS.getEbeguParameterByGesuchsperiodeCached(\n            this.gesuchModelManager.getGesuchsperiode().id,\n            this.globalCacheService.getCache(TSCacheTyp.EBEGU_PARAMETER)).then((response: TSEbeguParameter[]) => {\n            for (let i = 0; i < response.length; i++) {\n                if (response[i].name === TSEbeguParameterKey.PARAM_MAXIMALER_ZUSCHLAG_ERWERBSPENSUM) {\n                    // max Wert für Zuschlag Erwerbspensum\n                    this.maxZuschlagsprozent = Number(response[i].value);\n                }\n            }\n        });\n    }\n\n    getTaetigkeitenList(): Array<TSTaetigkeit> {\n        return getTSTaetigkeit();\n    }\n\n    getZuschlagsgrundList(): Array<TSZuschlagsgrund> {\n        if (this.authServiceRS.isOneOfRoles(TSRoleUtil.getGesuchstellerOnlyRoles())) {\n            return getTSZuschlagsgruendeForGS();\n        } else {\n            return getTSZuschlagsgrunde();\n        }\n    }\n\n    /**\n     * Beim speichern wird geschaut ob Zuschlagsgrund noetig ist, wenn nicht zuruecksetzten\n     * @param erwerbspensum\n     */\n    private maybeResetZuschlagsgrund(erwerbspensum: TSErwerbspensumContainer) {\n        if (erwerbspensum && !erwerbspensum.erwerbspensumJA.zuschlagZuErwerbspensum) {\n            erwerbspensum.erwerbspensumJA.zuschlagsprozent = undefined;\n            erwerbspensum.erwerbspensumJA.zuschlagsgrund = undefined;\n        }\n    }\n\n    save(): IPromise<any> {\n        if (this.isGesuchValid()) {\n\n            if (!this.form.$dirty) {\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.model);\n            }\n            this.maybeResetZuschlagsgrund(this.model);\n            this.errorService.clearAll();\n            return this.gesuchModelManager.saveErwerbspensum(this.gesuchsteller, this.model);\n        }\n        return undefined;\n    }\n\n    cancel() {\n        this.form.$setPristine();\n    }\n\n\n    private initEmptyEwpContainer(): TSErwerbspensumContainer {\n        let ewp = new TSErwerbspensum();\n        let ewpContainer = new TSErwerbspensumContainer();\n        ewpContainer.erwerbspensumJA = ewp;\n        return ewpContainer;\n\n    }\n\n    viewZuschlag(): boolean {\n        return this.model.erwerbspensumJA.taetigkeit === TSTaetigkeit.ANGESTELLT ||\n            this.model.erwerbspensumJA.taetigkeit === TSTaetigkeit.AUSBILDUNG ||\n            this.model.erwerbspensumJA.taetigkeit === TSTaetigkeit.SELBSTAENDIG;\n    }\n\n    taetigkeitChanged() {\n        if (!this.viewZuschlag()) {\n            this.model.erwerbspensumJA.zuschlagZuErwerbspensum = false;\n            this.model.erwerbspensumJA.zuschlagsprozent = undefined;\n            this.model.erwerbspensumJA.zuschlagsgrund = undefined;\n        }\n    }\n\n    erwerbspensumDisabled(): boolean {\n        // Disabled wenn Mutation, ausser bei Bearbeiter Jugendamt\n        return this.model.erwerbspensumJA.vorgaengerId && !this.authServiceRS.isOneOfRoles(TSRoleUtil.getAdministratorJugendamtRole());\n    }\n\n    public getTextZuschlagErwerbspensumKorrekturJA(): string {\n        if (this.model.erwerbspensumGS && this.model.erwerbspensumGS.zuschlagZuErwerbspensum === true) {\n            let ewp: TSErwerbspensum = this.model.erwerbspensumGS;\n            let grundText = this.$translate.instant(ewp.zuschlagsgrund.toString());\n            return this.$translate.instant('JA_KORREKTUR_ZUSCHLAG_ERWERBSPENSUM', {\n                zuschlagsgrund: grundText,\n                zuschlagsprozent: ewp.zuschlagsprozent\n            });\n        } else {\n            return this.$translate.instant('LABEL_KEINE_ANGABE');\n        }\n    }\n\n    public getZuschlagHelpText(): string {\n        return this.$translate.instant('ZUSCHLAGSGRUND_HELP', {\n            maxzuschlag: this.maxZuschlagsprozent\n        });\n    }\n\n}\n"]}]}
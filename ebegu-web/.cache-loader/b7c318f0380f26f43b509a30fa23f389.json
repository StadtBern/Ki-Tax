{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/finanzielleSituationStartView/finanzielleSituationStartView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/finanzielleSituationStartView/finanzielleSituationStartView.ts","mtime":1518612532802},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["\"use strict\";\n/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar TSWizardStepStatus_1 = require(\"../../../models/enums/TSWizardStepStatus\");\nvar abstractGesuchView_1 = require(\"../abstractGesuchView\");\nvar TSWizardStepName_1 = require(\"../../../models/enums/TSWizardStepName\");\nvar TSFinanzModel_1 = require(\"../../../models/TSFinanzModel\");\nvar RemoveDialogController_1 = require(\"../../dialog/RemoveDialogController\");\nvar template = require('./finanzielleSituationStartView.html');\nrequire('./finanzielleSituationStartView.less');\nvar removeDialogTemplate = require('../../dialog/removeDialogTemplate.html');\nvar FinanzielleSituationStartViewComponentConfig = /** @class */ (function () {\n    function FinanzielleSituationStartViewComponentConfig() {\n        this.transclude = false;\n        this.template = template;\n        this.controller = FinanzielleSituationStartViewController;\n        this.controllerAs = 'vm';\n    }\n    return FinanzielleSituationStartViewComponentConfig;\n}());\nexports.FinanzielleSituationStartViewComponentConfig = FinanzielleSituationStartViewComponentConfig;\nvar FinanzielleSituationStartViewController = /** @class */ (function (_super) {\n    __extends(FinanzielleSituationStartViewController, _super);\n    /* @ngInject */\n    function FinanzielleSituationStartViewController(gesuchModelManager, berechnungsManager, errorService, wizardStepManager, $q, $scope, $timeout, dvDialog) {\n        var _this = _super.call(this, gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName_1.TSWizardStepName.FINANZIELLE_SITUATION, $timeout) || this;\n        _this.errorService = errorService;\n        _this.$q = $q;\n        _this.dvDialog = dvDialog;\n        _this.model = new TSFinanzModel_1.default(_this.gesuchModelManager.getBasisjahr(), _this.gesuchModelManager.isGesuchsteller2Required(), null);\n        _this.model.copyFinSitDataFromGesuch(_this.gesuchModelManager.getGesuch());\n        _this.initialModel = angular.copy(_this.model);\n        _this.allowedRoles = _this.TSRoleUtil.getAllRolesButTraegerschaftInstitution();\n        _this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus_1.TSWizardStepStatus.IN_BEARBEITUNG);\n        _this.areThereOnlySchulamtangebote = _this.gesuchModelManager.areThereOnlySchulamtAngebote(); // so we load it just once\n        _this.areThereOnlyFerieninsel = _this.gesuchModelManager.areThereOnlyFerieninsel(); // so we load it just once\n        return _this;\n    }\n    FinanzielleSituationStartViewController.prototype.showSteuerveranlagung = function () {\n        return this.model.gemeinsameSteuererklaerung === true;\n    };\n    FinanzielleSituationStartViewController.prototype.showSteuererklaerung = function () {\n        return this.getFinanzielleSituationGS1().steuerveranlagungErhalten === false;\n    };\n    FinanzielleSituationStartViewController.prototype.save = function () {\n        var _this = this;\n        this.errorService.clearAll();\n        return this.gesuchModelManager.saveFinanzielleSituationStart()\n            .then(function (gesuch) {\n            // Noetig, da nur das ganze Gesuch upgedated wird und die Aeenderng bei der FinSit sonst nicht\n            // bemerkt werden\n            if (_this.gesuchModelManager.getGesuch().isMutation()) {\n                _this.wizardStepManager.updateCurrentWizardStepStatusMutiert();\n            }\n            return gesuch;\n        });\n    };\n    FinanzielleSituationStartViewController.prototype.confirmAndSave = function () {\n        var _this = this;\n        if (this.isGesuchValid()) {\n            this.model.copyFinSitDataToGesuch(this.gesuchModelManager.getGesuch());\n            if (!this.form.$dirty) {\n                if (this.updateStepDueToOnlyFerieninsel()) {\n                    return this.wizardStepManager.updateWizardStepStatus(TSWizardStepName_1.TSWizardStepName.FINANZIELLE_SITUATION, TSWizardStepStatus_1.TSWizardStepStatus.OK).then(function () {\n                        return _this.gesuchModelManager.getGesuch();\n                    });\n                }\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.gesuchModelManager.getGesuch());\n            }\n            if (this.finanzielleSituationTurnedNotRequired()) {\n                return this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController_1.RemoveDialogController, {\n                    title: 'FINSIT_WARNING',\n                    deleteText: 'FINSIT_WARNING_BESCHREIBUNG',\n                    parentController: undefined,\n                    elementID: undefined,\n                    form: this.form\n                }).then(function () {\n                    return _this.save();\n                });\n            }\n            else {\n                return this.save();\n            }\n        }\n        return undefined;\n    };\n    /**\n     * Id the Step is still in status IN_BEARBEITUNG and there are only Ferieninsel, the Gesuch must be updated.\n     */\n    FinanzielleSituationStartViewController.prototype.updateStepDueToOnlyFerieninsel = function () {\n        return this.wizardStepManager.hasStepGivenStatus(TSWizardStepName_1.TSWizardStepName.FINANZIELLE_SITUATION, TSWizardStepStatus_1.TSWizardStepStatus.IN_BEARBEITUNG)\n            && this.gesuchModelManager.getGesuch().areThereOnlyFerieninsel();\n    };\n    FinanzielleSituationStartViewController.prototype.finanzielleSituationTurnedNotRequired = function () {\n        return this.initialModel.isFinanzielleSituationDesired() && !this.model.isFinanzielleSituationDesired();\n    };\n    FinanzielleSituationStartViewController.prototype.getFinanzielleSituationGS1 = function () {\n        return this.model.finanzielleSituationContainerGS1.finanzielleSituationJA;\n    };\n    FinanzielleSituationStartViewController.prototype.getFinanzielleSituationGS2 = function () {\n        return this.model.finanzielleSituationContainerGS2.finanzielleSituationJA;\n    };\n    FinanzielleSituationStartViewController.prototype.isFinanziellesituationRequired = function () {\n        return this.finanzielleSituationRequired;\n    };\n    FinanzielleSituationStartViewController.prototype.hasTagesschulenAnmeldung = function () {\n        return this.gesuchModelManager.getGesuchsperiode().hasTagesschulenAnmeldung();\n    };\n    FinanzielleSituationStartViewController.prototype.gemeinsameStekClicked = function () {\n        if (this.model.gemeinsameSteuererklaerung === false && this.model.finanzielleSituationContainerGS1 && !this.model.finanzielleSituationContainerGS1.isNew()) {\n            // Wenn neu NEIN und schon was eingegeben -> Fragen mal auf false setzen und Status auf nok damit man sicher noch weiter muss!\n            this.initSteuerFragen();\n            this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus_1.TSWizardStepStatus.NOK);\n        }\n        else if (this.model.gemeinsameSteuererklaerung === false) {\n            // Wenn neu NEIN -> Fragen loeschen wenn noch nichts eingegeben worden ist\n            this.model.finanzielleSituationContainerGS1 = undefined;\n            this.model.finanzielleSituationContainerGS2 = undefined;\n        }\n        else {\n            this.model.initFinSit();\n        }\n    };\n    /**\n     * Es muss ein Wert geschrieben werden, um finsit persisierten zu können -> setzt die Antwort der Fragen auf false\n     */\n    FinanzielleSituationStartViewController.prototype.initSteuerFragen = function () {\n        if (this.model.finanzielleSituationContainerGS1) {\n            var gs1FinanzielleSituationJA = this.model.finanzielleSituationContainerGS1.finanzielleSituationJA;\n            gs1FinanzielleSituationJA.steuererklaerungAusgefuellt = !gs1FinanzielleSituationJA.steuererklaerungAusgefuellt ? false : gs1FinanzielleSituationJA.steuererklaerungAusgefuellt;\n            gs1FinanzielleSituationJA.steuerveranlagungErhalten = !gs1FinanzielleSituationJA.steuerveranlagungErhalten ? false : gs1FinanzielleSituationJA.steuerveranlagungErhalten;\n        }\n        if (this.model.finanzielleSituationContainerGS2) {\n            var gs2FinanzielleSituationJA = this.model.finanzielleSituationContainerGS2.finanzielleSituationJA;\n            gs2FinanzielleSituationJA.steuererklaerungAusgefuellt = !gs2FinanzielleSituationJA.steuererklaerungAusgefuellt ? false : gs2FinanzielleSituationJA.steuererklaerungAusgefuellt;\n            gs2FinanzielleSituationJA.steuerveranlagungErhalten = !gs2FinanzielleSituationJA.steuerveranlagungErhalten ? false : gs2FinanzielleSituationJA.steuerveranlagungErhalten;\n        }\n    };\n    FinanzielleSituationStartViewController.prototype.steuerveranlagungClicked = function () {\n        // Wenn Steuerveranlagung JA -> auch StekErhalten -> JA\n        // Wenn zusätzlich noch GemeinsameStek -> Dasselbe auch für GS2\n        // Wenn Steuerveranlagung erhalten, muss auch STEK ausgefüllt worden sein\n        if (this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuerveranlagungErhalten === true) {\n            this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuererklaerungAusgefuellt = true;\n            if (this.model.gemeinsameSteuererklaerung === true) {\n                this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuerveranlagungErhalten = true;\n                this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuererklaerungAusgefuellt = true;\n            }\n        }\n        else if (this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuerveranlagungErhalten === false) {\n            // Steuerveranlagung neu NEIN -> Fragen loeschen\n            this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuererklaerungAusgefuellt = undefined;\n            if (this.model.gemeinsameSteuererklaerung === true) {\n                this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuerveranlagungErhalten = false;\n                this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuererklaerungAusgefuellt = undefined;\n            }\n        }\n    };\n    FinanzielleSituationStartViewController.prototype.steuererklaerungClicked = function () {\n        if (this.model.gemeinsameSteuererklaerung === true) {\n            this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuererklaerungAusgefuellt =\n                this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuererklaerungAusgefuellt;\n        }\n    };\n    FinanzielleSituationStartViewController.prototype.is2GSRequired = function () {\n        return this.gesuchModelManager.isGesuchsteller2Required();\n    };\n    FinanzielleSituationStartViewController.$inject = ['GesuchModelManager', 'BerechnungsManager', 'ErrorService',\n        'WizardStepManager', '$q', '$scope', '$timeout', 'DvDialog'];\n    return FinanzielleSituationStartViewController;\n}(abstractGesuchView_1.default));\nexports.FinanzielleSituationStartViewController = FinanzielleSituationStartViewController;\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/finanzielleSituationStartView/finanzielleSituationStartView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/gesuch/component/finanzielleSituationStartView/finanzielleSituationStartView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2017 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {IComponentOptions} from 'angular';\nimport GesuchModelManager from '../../service/gesuchModelManager';\nimport TSFinanzielleSituation from '../../../models/TSFinanzielleSituation';\nimport BerechnungsManager from '../../service/berechnungsManager';\nimport ErrorService from '../../../core/errors/service/ErrorService';\nimport WizardStepManager from '../../service/wizardStepManager';\nimport {TSWizardStepStatus} from '../../../models/enums/TSWizardStepStatus';\nimport IQService = angular.IQService;\nimport IScope = angular.IScope;\nimport ITimeoutService = angular.ITimeoutService;\nimport IPromise = angular.IPromise;\nimport AbstractGesuchViewController from '../abstractGesuchView';\nimport {TSRoleUtil} from '../../../utils/TSRoleUtil';\nimport {TSWizardStepName} from '../../../models/enums/TSWizardStepName';\nimport TSFinanzModel from '../../../models/TSFinanzModel';\nimport TSGesuch from '../../../models/TSGesuch';\nimport {RemoveDialogController} from '../../dialog/RemoveDialogController';\nimport {DvDialog} from '../../../core/directive/dv-dialog/dv-dialog';\n\nlet template = require('./finanzielleSituationStartView.html');\nrequire('./finanzielleSituationStartView.less');\nlet removeDialogTemplate = require('../../dialog/removeDialogTemplate.html');\n\nexport class FinanzielleSituationStartViewComponentConfig implements IComponentOptions {\n    transclude = false;\n    template = template;\n    controller = FinanzielleSituationStartViewController;\n    controllerAs = 'vm';\n}\n\nexport class FinanzielleSituationStartViewController extends AbstractGesuchViewController<TSFinanzModel> {\n\n    finanzielleSituationRequired: boolean;\n    areThereOnlySchulamtangebote: boolean;\n    areThereOnlyFerieninsel: boolean;\n    allowedRoles: Array<TSRoleUtil>;\n    private initialModel: TSFinanzModel;\n\n\n    static $inject: string[] = ['GesuchModelManager', 'BerechnungsManager', 'ErrorService',\n        'WizardStepManager', '$q', '$scope', '$timeout', 'DvDialog'];\n\n    /* @ngInject */\n    constructor(gesuchModelManager: GesuchModelManager, berechnungsManager: BerechnungsManager, private errorService: ErrorService,\n                wizardStepManager: WizardStepManager, private $q: IQService, $scope: IScope, $timeout: ITimeoutService,\n                private dvDialog: DvDialog) {\n        super(gesuchModelManager, berechnungsManager, wizardStepManager, $scope, TSWizardStepName.FINANZIELLE_SITUATION, $timeout);\n\n        this.model = new TSFinanzModel(this.gesuchModelManager.getBasisjahr(), this.gesuchModelManager.isGesuchsteller2Required(), null);\n        this.model.copyFinSitDataFromGesuch(this.gesuchModelManager.getGesuch());\n        this.initialModel = angular.copy(this.model);\n\n        this.allowedRoles = this.TSRoleUtil.getAllRolesButTraegerschaftInstitution();\n        this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus.IN_BEARBEITUNG);\n        this.areThereOnlySchulamtangebote = this.gesuchModelManager.areThereOnlySchulamtAngebote(); // so we load it just once\n        this.areThereOnlyFerieninsel = this.gesuchModelManager.areThereOnlyFerieninsel(); // so we load it just once\n    }\n\n    showSteuerveranlagung(): boolean {\n        return this.model.gemeinsameSteuererklaerung === true;\n    }\n\n    showSteuererklaerung(): boolean {\n        return this.getFinanzielleSituationGS1().steuerveranlagungErhalten === false;\n    }\n\n    private save(): IPromise<TSGesuch> {\n        this.errorService.clearAll();\n        return this.gesuchModelManager.saveFinanzielleSituationStart()\n            .then((gesuch: TSGesuch) => {\n                // Noetig, da nur das ganze Gesuch upgedated wird und die Aeenderng bei der FinSit sonst nicht\n                // bemerkt werden\n                if (this.gesuchModelManager.getGesuch().isMutation()) {\n                    this.wizardStepManager.updateCurrentWizardStepStatusMutiert();\n                }\n                return gesuch;\n            });\n    }\n\n    private confirmAndSave(): IPromise<TSGesuch> {\n        if (this.isGesuchValid()) {\n            this.model.copyFinSitDataToGesuch(this.gesuchModelManager.getGesuch());\n            if (!this.form.$dirty) {\n                if (this.updateStepDueToOnlyFerieninsel()) {\n                    return this.wizardStepManager.updateWizardStepStatus(TSWizardStepName.FINANZIELLE_SITUATION, TSWizardStepStatus.OK).then(() => {\n                        return this.gesuchModelManager.getGesuch();\n                    });\n                }\n                // If there are no changes in form we don't need anything to update on Server and we could return the\n                // promise immediately\n                return this.$q.when(this.gesuchModelManager.getGesuch());\n            }\n            if (this.finanzielleSituationTurnedNotRequired()) {\n                return this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController, {\n                    title: 'FINSIT_WARNING',\n                    deleteText: 'FINSIT_WARNING_BESCHREIBUNG',\n                    parentController: undefined,\n                    elementID: undefined,\n                    form: this.form\n                }).then(() => {   //User confirmed changes\n                    return this.save();\n                });\n            } else {\n                return this.save();\n            }\n        }\n        return undefined;\n    }\n\n    /**\n     * Id the Step is still in status IN_BEARBEITUNG and there are only Ferieninsel, the Gesuch must be updated.\n     */\n    private updateStepDueToOnlyFerieninsel() {\n        return this.wizardStepManager.hasStepGivenStatus(TSWizardStepName.FINANZIELLE_SITUATION, TSWizardStepStatus.IN_BEARBEITUNG)\n            && this.gesuchModelManager.getGesuch().areThereOnlyFerieninsel();\n    }\n\n    public finanzielleSituationTurnedNotRequired(): boolean {\n        return this.initialModel.isFinanzielleSituationDesired() && !this.model.isFinanzielleSituationDesired();\n    }\n\n    public getFinanzielleSituationGS1(): TSFinanzielleSituation {\n        return this.model.finanzielleSituationContainerGS1.finanzielleSituationJA;\n    }\n\n    private getFinanzielleSituationGS2(): TSFinanzielleSituation {\n        return this.model.finanzielleSituationContainerGS2.finanzielleSituationJA;\n    }\n\n    public isFinanziellesituationRequired(): boolean {\n        return this.finanzielleSituationRequired;\n    }\n\n    private hasTagesschulenAnmeldung(): boolean {\n        return this.gesuchModelManager.getGesuchsperiode().hasTagesschulenAnmeldung();\n    }\n\n    public gemeinsameStekClicked(): void {\n        if (this.model.gemeinsameSteuererklaerung === false && this.model.finanzielleSituationContainerGS1 && !this.model.finanzielleSituationContainerGS1.isNew()) {\n            // Wenn neu NEIN und schon was eingegeben -> Fragen mal auf false setzen und Status auf nok damit man sicher noch weiter muss!\n            this.initSteuerFragen();\n            this.wizardStepManager.updateCurrentWizardStepStatus(TSWizardStepStatus.NOK);\n        } else if (this.model.gemeinsameSteuererklaerung === false) {\n            // Wenn neu NEIN -> Fragen loeschen wenn noch nichts eingegeben worden ist\n            this.model.finanzielleSituationContainerGS1 = undefined;\n            this.model.finanzielleSituationContainerGS2 = undefined;\n        } else {\n            this.model.initFinSit();\n        }\n    }\n\n    /**\n     * Es muss ein Wert geschrieben werden, um finsit persisierten zu können -> setzt die Antwort der Fragen auf false\n     */\n    private initSteuerFragen() {\n        if (this.model.finanzielleSituationContainerGS1) {\n            let gs1FinanzielleSituationJA = this.model.finanzielleSituationContainerGS1.finanzielleSituationJA;\n            gs1FinanzielleSituationJA.steuererklaerungAusgefuellt = !gs1FinanzielleSituationJA.steuererklaerungAusgefuellt ? false : gs1FinanzielleSituationJA.steuererklaerungAusgefuellt;\n            gs1FinanzielleSituationJA.steuerveranlagungErhalten = !gs1FinanzielleSituationJA.steuerveranlagungErhalten ? false : gs1FinanzielleSituationJA.steuerveranlagungErhalten;\n        }\n        if (this.model.finanzielleSituationContainerGS2) {\n            let gs2FinanzielleSituationJA = this.model.finanzielleSituationContainerGS2.finanzielleSituationJA;\n            gs2FinanzielleSituationJA.steuererklaerungAusgefuellt = !gs2FinanzielleSituationJA.steuererklaerungAusgefuellt ? false : gs2FinanzielleSituationJA.steuererklaerungAusgefuellt;\n            gs2FinanzielleSituationJA.steuerveranlagungErhalten = !gs2FinanzielleSituationJA.steuerveranlagungErhalten ? false : gs2FinanzielleSituationJA.steuerveranlagungErhalten;\n\n        }\n    }\n\n    public steuerveranlagungClicked(): void {\n        // Wenn Steuerveranlagung JA -> auch StekErhalten -> JA\n        // Wenn zusätzlich noch GemeinsameStek -> Dasselbe auch für GS2\n        // Wenn Steuerveranlagung erhalten, muss auch STEK ausgefüllt worden sein\n        if (this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuerveranlagungErhalten === true) {\n            this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuererklaerungAusgefuellt = true;\n            if (this.model.gemeinsameSteuererklaerung === true) {\n                this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuerveranlagungErhalten = true;\n                this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuererklaerungAusgefuellt = true;\n            }\n        } else if (this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuerveranlagungErhalten === false) {\n            // Steuerveranlagung neu NEIN -> Fragen loeschen\n            this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuererklaerungAusgefuellt = undefined;\n            if (this.model.gemeinsameSteuererklaerung === true) {\n                this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuerveranlagungErhalten = false;\n                this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuererklaerungAusgefuellt = undefined;\n            }\n        }\n    }\n\n    public steuererklaerungClicked() {\n        if (this.model.gemeinsameSteuererklaerung === true) {\n            this.model.finanzielleSituationContainerGS2.finanzielleSituationJA.steuererklaerungAusgefuellt =\n                this.model.finanzielleSituationContainerGS1.finanzielleSituationJA.steuererklaerungAusgefuellt;\n        }\n    }\n\n    public is2GSRequired(): boolean {\n        return this.gesuchModelManager.isGesuchsteller2Required();\n    }\n}\n"]}]}
{"remainingRequest":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js??ref--0-1!/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js??ref--0-2!/home/imanol/projects/ebegu/ebegu-web/src/admin/component/gesuchsperiodeView/gesuchsperiodeView.ts","cacheIdentifier":"cache-loader:1.1.0 test","dependencies":[{"path":"/home/imanol/projects/ebegu/ebegu-web/src/admin/component/gesuchsperiodeView/gesuchsperiodeView.ts","mtime":1518009464603},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/cache-loader/dist/cjs.js","mtime":1507514019000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/thread-loader/dist/cjs.js","mtime":1507523420000},{"path":"/home/imanol/projects/ebegu/ebegu-web/node_modules/ts-loader/index.js","mtime":1508488471000}],"contextDependencies":[],"result":["\"use strict\";\n/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2018 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = Object.setPrototypeOf ||\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar abstractAdminView_1 = require(\"../../abstractAdminView\");\nvar TSGesuchsperiode_1 = require(\"../../../models/TSGesuchsperiode\");\nvar RemoveDialogController_1 = require(\"../../../gesuch/dialog/RemoveDialogController\");\nvar TSCacheTyp_1 = require(\"../../../models/enums/TSCacheTyp\");\nvar EbeguUtil_1 = require(\"../../../utils/EbeguUtil\");\nvar TSGesuchsperiodeStatus_1 = require(\"../../../models/enums/TSGesuchsperiodeStatus\");\nvar TSDateRange_1 = require(\"../../../models/types/TSDateRange\");\nvar template = require('./gesuchsperiodeView.html');\nvar removeDialogTemplate = require('../../../gesuch/dialog/removeDialogTemplate.html');\nvar GesuchsperiodeViewComponentConfig = /** @class */ (function () {\n    function GesuchsperiodeViewComponentConfig() {\n        this.transclude = false;\n        this.template = template;\n        this.controller = GesuchsperiodeViewController;\n        this.controllerAs = 'vm';\n    }\n    return GesuchsperiodeViewComponentConfig;\n}());\nexports.GesuchsperiodeViewComponentConfig = GesuchsperiodeViewComponentConfig;\nvar GesuchsperiodeViewController = /** @class */ (function (_super) {\n    __extends(GesuchsperiodeViewController, _super);\n    function GesuchsperiodeViewController(ebeguParameterRS, dvDialog, globalCacheService, gesuchsperiodeRS, $log, $stateParams, $state, authServiceRS) {\n        var _this = _super.call(this, authServiceRS) || this;\n        _this.ebeguParameterRS = ebeguParameterRS;\n        _this.dvDialog = dvDialog;\n        _this.globalCacheService = globalCacheService;\n        _this.gesuchsperiodeRS = gesuchsperiodeRS;\n        _this.$log = $log;\n        _this.$stateParams = $stateParams;\n        _this.$state = $state;\n        return _this;\n    }\n    GesuchsperiodeViewController.prototype.$onInit = function () {\n        var _this = this;\n        if (this.$stateParams.gesuchsperiodeId) {\n            this.gesuchsperiodeRS.findGesuchsperiode(this.$stateParams.gesuchsperiodeId).then(function (found) {\n                _this.setSelectedGesuchsperiode(found);\n                _this.initialStatus = _this.gesuchsperiode.status;\n            });\n        }\n        else {\n            this.createGesuchsperiode();\n        }\n    };\n    GesuchsperiodeViewController.prototype.getTSGesuchsperiodeStatusValues = function () {\n        return TSGesuchsperiodeStatus_1.getTSGesuchsperiodeStatusValues();\n    };\n    GesuchsperiodeViewController.prototype.setSelectedGesuchsperiode = function (gesuchsperiode) {\n        this.gesuchsperiode = gesuchsperiode;\n        this.readEbeguParameterByGesuchsperiode();\n        this.datumFreischaltungTagesschule = undefined;\n        this.datumFreischaltungMax = this.getDatumFreischaltungMax();\n    };\n    GesuchsperiodeViewController.prototype.readEbeguParameterByGesuchsperiode = function () {\n        var _this = this;\n        this.ebeguParameterRS.getEbeguParameterByGesuchsperiode(this.gesuchsperiode.id).then(function (response) {\n            _this.ebeguParameterListGesuchsperiode = response;\n        });\n    };\n    GesuchsperiodeViewController.prototype.cancelGesuchsperiode = function () {\n        this.$state.go('parameter');\n    };\n    GesuchsperiodeViewController.prototype.saveGesuchsperiode = function () {\n        var _this = this;\n        if (this.form.$valid && this.statusHaveChanged()) {\n            // Den Dialog nur aufrufen, wenn der Status geändert wurde (oder die GP neu ist) oder wenn es AKTIV ist\n            if (this.gesuchsperiode.isNew() || this.initialStatus !== this.gesuchsperiode.status || this.gesuchsperiode.status === TSGesuchsperiodeStatus_1.TSGesuchsperiodeStatus.AKTIV) {\n                var dialogText = this.getGesuchsperiodeSaveDialogText();\n                this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController_1.RemoveDialogController, {\n                    title: 'GESUCHSPERIODE_DIALOG_TITLE',\n                    deleteText: dialogText,\n                    parentController: undefined,\n                    elementID: undefined\n                }).then(function () {\n                    _this.saveGesuchsperiodeFreischaltungTagesschule();\n                });\n            }\n            else {\n                this.saveGesuchsperiodeFreischaltungTagesschule();\n            }\n        }\n    };\n    GesuchsperiodeViewController.prototype.saveGesuchsperiodeFreischaltungTagesschule = function () {\n        var _this = this;\n        // Zweite Rückfrage falls neu ein Datum für die Freischaltung der Tagesschulen gesetzt wurde\n        if (!this.gesuchsperiode.isTagesschulenAnmeldungKonfiguriert() && this.isDatumFreischaltungTagesschuleValid()) {\n            this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController_1.RemoveDialogController, {\n                title: 'FREISCHALTUNG_TAGESSCHULE_DIALOG_TITLE',\n                deleteText: 'FREISCHALTUNG_TAGESSCHULE_DIALOG_TEXT',\n                parentController: undefined,\n                elementID: undefined\n            }).then(function () {\n                _this.gesuchsperiode.datumFreischaltungTagesschule = _this.datumFreischaltungTagesschule;\n                _this.doSave();\n            });\n        }\n        else {\n            this.doSave();\n        }\n    };\n    GesuchsperiodeViewController.prototype.isDatumFreischaltungTagesschuleValid = function () {\n        return this.datumFreischaltungTagesschule && this.datumFreischaltungTagesschule.isBefore(this.gesuchsperiode.gueltigkeit.gueltigAb);\n    };\n    GesuchsperiodeViewController.prototype.doSave = function () {\n        var _this = this;\n        this.gesuchsperiodeRS.updateGesuchsperiode(this.gesuchsperiode).then(function (response) {\n            _this.gesuchsperiode = response;\n            _this.datumFreischaltungTagesschule = undefined;\n            _this.globalCacheService.getCache(TSCacheTyp_1.TSCacheTyp.EBEGU_PARAMETER).removeAll();\n            // Die E-BEGU-Parameter für die neue Periode lesen bzw. erstellen, wenn noch nicht vorhanden\n            _this.readEbeguParameterByGesuchsperiode();\n            _this.gesuchsperiodeRS.updateActiveGesuchsperiodenList(); //reset gesuchperioden in manager\n            _this.gesuchsperiodeRS.updateNichtAbgeschlosseneGesuchsperiodenList();\n            _this.initialStatus = _this.gesuchsperiode.status;\n        });\n    };\n    GesuchsperiodeViewController.prototype.createGesuchsperiode = function () {\n        var _this = this;\n        this.gesuchsperiodeRS.getNewestGesuchsperiode().then(function (newestGeuschsperiode) {\n            _this.gesuchsperiode = new TSGesuchsperiode_1.default(TSGesuchsperiodeStatus_1.TSGesuchsperiodeStatus.ENTWURF, new TSDateRange_1.TSDateRange());\n            _this.initialStatus = undefined; //initialStatus ist undefined for new created Gesuchsperioden\n            _this.datumFreischaltungTagesschule = undefined;\n            _this.gesuchsperiode.gueltigkeit.gueltigAb = newestGeuschsperiode.gueltigkeit.gueltigAb.clone().add(1, 'years');\n            _this.gesuchsperiode.gueltigkeit.gueltigBis = newestGeuschsperiode.gueltigkeit.gueltigBis.clone().add(1, 'years');\n            _this.gesuchsperiode.datumFreischaltungTagesschule = _this.gesuchsperiode.gueltigkeit.gueltigAb;\n            _this.datumFreischaltungMax = _this.getDatumFreischaltungMax();\n        });\n        this.gesuchsperiode = undefined;\n    };\n    GesuchsperiodeViewController.prototype.saveParameterByGesuchsperiode = function () {\n        for (var i = 0; i < this.ebeguParameterListGesuchsperiode.length; i++) {\n            var param = this.ebeguParameterListGesuchsperiode[i];\n            this.ebeguParameterRS.saveEbeguParameter(param);\n        }\n        this.globalCacheService.getCache(TSCacheTyp_1.TSCacheTyp.EBEGU_PARAMETER).removeAll();\n        this.gesuchsperiodeRS.updateActiveGesuchsperiodenList();\n        this.gesuchsperiodeRS.updateNichtAbgeschlosseneGesuchsperiodenList();\n    };\n    GesuchsperiodeViewController.prototype.getGesuchsperiodeSaveDialogText = function () {\n        if (this.gesuchsperiode.status === TSGesuchsperiodeStatus_1.TSGesuchsperiodeStatus.ENTWURF) {\n            return 'GESUCHSPERIODE_DIALOG_TEXT_ENTWURF';\n        }\n        if (this.gesuchsperiode.status === TSGesuchsperiodeStatus_1.TSGesuchsperiodeStatus.AKTIV) {\n            return 'GESUCHSPERIODE_DIALOG_TEXT_AKTIV';\n        }\n        if (this.gesuchsperiode.status === TSGesuchsperiodeStatus_1.TSGesuchsperiodeStatus.INAKTIV) {\n            return 'GESUCHSPERIODE_DIALOG_TEXT_INAKTIV';\n        }\n        if (this.gesuchsperiode.status === TSGesuchsperiodeStatus_1.TSGesuchsperiodeStatus.GESCHLOSSEN) {\n            return 'GESUCHSPERIODE_DIALOG_TEXT_GESCHLOSSEN';\n        }\n        this.$log.warn('Achtung, Status unbekannt: ', this.gesuchsperiode.status);\n        return null;\n    };\n    GesuchsperiodeViewController.prototype.ersterSchultagRequired = function () {\n        return (EbeguUtil_1.default.isNotNullOrUndefined(this.gesuchsperiode.datumFreischaltungTagesschule)\n            && this.gesuchsperiode.datumFreischaltungTagesschule.isBefore(this.gesuchsperiode.gueltigkeit.gueltigAb))\n            || (EbeguUtil_1.default.isNotNullOrUndefined(this.datumFreischaltungTagesschule)\n                && this.datumFreischaltungTagesschule.isBefore(this.gesuchsperiode.gueltigkeit.gueltigAb));\n    };\n    GesuchsperiodeViewController.prototype.periodenParamsEditable = function () {\n        return this.periodenParamsEditableForPeriode(this.gesuchsperiode);\n    };\n    /**\n     * Gibt true zurueck wenn der Status sich geaendert hat oder wenn der Status AKTIV ist, da in Status AKTIV, die Parameter (Tagesschule)\n     * noch geaendert werden koennen.\n     */\n    GesuchsperiodeViewController.prototype.statusHaveChanged = function () {\n        return this.initialStatus !== this.gesuchsperiode.status || this.gesuchsperiode.status === TSGesuchsperiodeStatus_1.TSGesuchsperiodeStatus.AKTIV;\n    };\n    GesuchsperiodeViewController.prototype.getDatumFreischaltungMax = function () {\n        var gueltigAb = angular.copy(this.gesuchsperiode.gueltigkeit.gueltigAb);\n        return gueltigAb.subtract(1, 'days');\n    };\n    GesuchsperiodeViewController.$inject = ['EbeguParameterRS', 'DvDialog', 'GlobalCacheService', 'GesuchsperiodeRS', '$log', '$stateParams',\n        '$state', 'AuthServiceRS'];\n    return GesuchsperiodeViewController;\n}(abstractAdminView_1.default));\nexports.GesuchsperiodeViewController = GesuchsperiodeViewController;\n",{"version":3,"file":"/home/imanol/projects/ebegu/ebegu-web/src/admin/component/gesuchsperiodeView/gesuchsperiodeView.ts","sourceRoot":"","sources":["/home/imanol/projects/ebegu/ebegu-web/src/admin/component/gesuchsperiodeView/gesuchsperiodeView.ts"],"names":[],"mappings":"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","sourcesContent":["/*\n * Ki-Tax: System for the management of external childcare subsidies\n * Copyright (C) 2018 City of Bern Switzerland\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n */\n\nimport {IComponentOptions, IFormController, ILogService} from 'angular';\nimport AbstractAdminViewController from '../../abstractAdminView';\nimport TSGesuchsperiode from '../../../models/TSGesuchsperiode';\nimport {RemoveDialogController} from '../../../gesuch/dialog/RemoveDialogController';\nimport moment = require('moment');\nimport TSEbeguParameter from '../../../models/TSEbeguParameter';\nimport {TSCacheTyp} from '../../../models/enums/TSCacheTyp';\nimport EbeguUtil from '../../../utils/EbeguUtil';\nimport {getTSGesuchsperiodeStatusValues, TSGesuchsperiodeStatus} from '../../../models/enums/TSGesuchsperiodeStatus';\nimport {EbeguParameterRS} from '../../service/ebeguParameterRS.rest';\nimport AuthServiceRS from '../../../authentication/service/AuthServiceRS.rest';\nimport {DvDialog} from '../../../core/directive/dv-dialog/dv-dialog';\nimport GlobalCacheService from '../../../gesuch/service/globalCacheService';\nimport GesuchsperiodeRS from '../../../core/service/gesuchsperiodeRS.rest';\nimport {TSDateRange} from '../../../models/types/TSDateRange';\nimport {IGesuchsperiodeStateParams} from '../../admin.route';\nimport IStateService = angular.ui.IStateService;\n\nlet template = require('./gesuchsperiodeView.html');\nlet removeDialogTemplate = require('../../../gesuch/dialog/removeDialogTemplate.html');\n\n\nexport class GesuchsperiodeViewComponentConfig implements IComponentOptions {\n    transclude: boolean = false;\n    template: string = template;\n    controller: any = GesuchsperiodeViewController;\n    controllerAs: string = 'vm';\n}\n\nexport class GesuchsperiodeViewController extends AbstractAdminViewController {\n\n    form: IFormController;\n    gesuchsperiode: TSGesuchsperiode;\n    ebeguParameterListGesuchsperiode: TSEbeguParameter[];\n\n    initialStatus: TSGesuchsperiodeStatus;\n    datumFreischaltungTagesschule: moment.Moment;\n    datumFreischaltungMax: moment.Moment;\n\n\n    static $inject = ['EbeguParameterRS', 'DvDialog', 'GlobalCacheService', 'GesuchsperiodeRS', '$log', '$stateParams',\n        '$state', 'AuthServiceRS'];\n\n    constructor(private ebeguParameterRS: EbeguParameterRS, private dvDialog: DvDialog, private globalCacheService: GlobalCacheService,\n                private gesuchsperiodeRS: GesuchsperiodeRS, private $log: ILogService, private $stateParams: IGesuchsperiodeStateParams,\n                private $state: IStateService, authServiceRS: AuthServiceRS) {\n        super(authServiceRS);\n    }\n\n    $onInit() {\n        if (this.$stateParams.gesuchsperiodeId) {\n            this.gesuchsperiodeRS.findGesuchsperiode(this.$stateParams.gesuchsperiodeId).then((found: TSGesuchsperiode) => {\n                this.setSelectedGesuchsperiode(found);\n                this.initialStatus = this.gesuchsperiode.status;\n            });\n        } else {\n            this.createGesuchsperiode();\n        }\n    }\n\n    public getTSGesuchsperiodeStatusValues(): Array<TSGesuchsperiodeStatus> {\n        return getTSGesuchsperiodeStatusValues();\n    }\n\n    private setSelectedGesuchsperiode(gesuchsperiode: any): void {\n        this.gesuchsperiode = gesuchsperiode;\n        this.readEbeguParameterByGesuchsperiode();\n        this.datumFreischaltungTagesschule = undefined;\n        this.datumFreischaltungMax = this.getDatumFreischaltungMax();\n    }\n\n    private readEbeguParameterByGesuchsperiode(): void {\n        this.ebeguParameterRS.getEbeguParameterByGesuchsperiode(this.gesuchsperiode.id).then((response: TSEbeguParameter[]) => {\n            this.ebeguParameterListGesuchsperiode = response;\n        });\n    }\n\n    public cancelGesuchsperiode(): void {\n        this.$state.go('parameter');\n    }\n\n    public saveGesuchsperiode(): void {\n        if (this.form.$valid && this.statusHaveChanged()) {\n            // Den Dialog nur aufrufen, wenn der Status geändert wurde (oder die GP neu ist) oder wenn es AKTIV ist\n            if (this.gesuchsperiode.isNew() || this.initialStatus !== this.gesuchsperiode.status || this.gesuchsperiode.status === TSGesuchsperiodeStatus.AKTIV) {\n                let dialogText = this.getGesuchsperiodeSaveDialogText();\n                this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController, {\n                    title: 'GESUCHSPERIODE_DIALOG_TITLE',\n                    deleteText: dialogText,\n                    parentController: undefined,\n                    elementID: undefined\n                }).then(() => {\n                    this.saveGesuchsperiodeFreischaltungTagesschule();\n                });\n            } else {\n                this.saveGesuchsperiodeFreischaltungTagesschule();\n            }\n        }\n    }\n\n    public saveGesuchsperiodeFreischaltungTagesschule(): void {\n        // Zweite Rückfrage falls neu ein Datum für die Freischaltung der Tagesschulen gesetzt wurde\n        if (!this.gesuchsperiode.isTagesschulenAnmeldungKonfiguriert() && this.isDatumFreischaltungTagesschuleValid()) {\n            this.dvDialog.showDialog(removeDialogTemplate, RemoveDialogController, {\n                title: 'FREISCHALTUNG_TAGESSCHULE_DIALOG_TITLE',\n                deleteText: 'FREISCHALTUNG_TAGESSCHULE_DIALOG_TEXT',\n                parentController: undefined,\n                elementID: undefined\n            }).then(() => {\n                this.gesuchsperiode.datumFreischaltungTagesschule = this.datumFreischaltungTagesschule;\n                this.doSave();\n            });\n        } else {\n            this.doSave();\n        }\n    }\n\n    private isDatumFreischaltungTagesschuleValid() {\n        return this.datumFreischaltungTagesschule && this.datumFreischaltungTagesschule.isBefore(this.gesuchsperiode.gueltigkeit.gueltigAb);\n    }\n\n    private doSave(): void {\n        this.gesuchsperiodeRS.updateGesuchsperiode(this.gesuchsperiode).then((response: TSGesuchsperiode) => {\n            this.gesuchsperiode = response;\n            this.datumFreischaltungTagesschule = undefined;\n            this.globalCacheService.getCache(TSCacheTyp.EBEGU_PARAMETER).removeAll();\n            // Die E-BEGU-Parameter für die neue Periode lesen bzw. erstellen, wenn noch nicht vorhanden\n            this.readEbeguParameterByGesuchsperiode();\n            this.gesuchsperiodeRS.updateActiveGesuchsperiodenList(); //reset gesuchperioden in manager\n            this.gesuchsperiodeRS.updateNichtAbgeschlosseneGesuchsperiodenList();\n            this.initialStatus = this.gesuchsperiode.status;\n        });\n    }\n\n    public createGesuchsperiode(): void {\n        this.gesuchsperiodeRS.getNewestGesuchsperiode().then(newestGeuschsperiode => {\n            this.gesuchsperiode = new TSGesuchsperiode(TSGesuchsperiodeStatus.ENTWURF, new TSDateRange());\n            this.initialStatus = undefined; //initialStatus ist undefined for new created Gesuchsperioden\n            this.datumFreischaltungTagesschule = undefined;\n            this.gesuchsperiode.gueltigkeit.gueltigAb = newestGeuschsperiode.gueltigkeit.gueltigAb.clone().add(1, 'years');\n            this.gesuchsperiode.gueltigkeit.gueltigBis = newestGeuschsperiode.gueltigkeit.gueltigBis.clone().add(1, 'years');\n            this.gesuchsperiode.datumFreischaltungTagesschule = this.gesuchsperiode.gueltigkeit.gueltigAb;\n            this.datumFreischaltungMax = this.getDatumFreischaltungMax();\n        });\n        this.gesuchsperiode = undefined;\n    }\n\n    public saveParameterByGesuchsperiode(): void {\n        for (let i = 0; i < this.ebeguParameterListGesuchsperiode.length; i++) {\n            let param = this.ebeguParameterListGesuchsperiode[i];\n            this.ebeguParameterRS.saveEbeguParameter(param);\n        }\n        this.globalCacheService.getCache(TSCacheTyp.EBEGU_PARAMETER).removeAll();\n        this.gesuchsperiodeRS.updateActiveGesuchsperiodenList();\n        this.gesuchsperiodeRS.updateNichtAbgeschlosseneGesuchsperiodenList();\n    }\n\n    private getGesuchsperiodeSaveDialogText(): string {\n        if (this.gesuchsperiode.status === TSGesuchsperiodeStatus.ENTWURF) {\n            return 'GESUCHSPERIODE_DIALOG_TEXT_ENTWURF';\n        }\n        if (this.gesuchsperiode.status === TSGesuchsperiodeStatus.AKTIV) {\n            return 'GESUCHSPERIODE_DIALOG_TEXT_AKTIV';\n        }\n        if (this.gesuchsperiode.status === TSGesuchsperiodeStatus.INAKTIV) {\n            return 'GESUCHSPERIODE_DIALOG_TEXT_INAKTIV';\n        }\n        if (this.gesuchsperiode.status === TSGesuchsperiodeStatus.GESCHLOSSEN) {\n            return 'GESUCHSPERIODE_DIALOG_TEXT_GESCHLOSSEN';\n        }\n        this.$log.warn('Achtung, Status unbekannt: ', this.gesuchsperiode.status);\n        return null;\n    }\n\n    public ersterSchultagRequired(): boolean {\n        return (EbeguUtil.isNotNullOrUndefined(this.gesuchsperiode.datumFreischaltungTagesschule)\n            &&  this.gesuchsperiode.datumFreischaltungTagesschule.isBefore(this.gesuchsperiode.gueltigkeit.gueltigAb))\n            || (EbeguUtil.isNotNullOrUndefined(this.datumFreischaltungTagesschule)\n                && this.datumFreischaltungTagesschule.isBefore(this.gesuchsperiode.gueltigkeit.gueltigAb));\n    }\n\n    public periodenParamsEditable(): boolean {\n        return this.periodenParamsEditableForPeriode(this.gesuchsperiode);\n    }\n\n    /**\n     * Gibt true zurueck wenn der Status sich geaendert hat oder wenn der Status AKTIV ist, da in Status AKTIV, die Parameter (Tagesschule)\n     * noch geaendert werden koennen.\n     */\n    private statusHaveChanged() {\n        return this.initialStatus !== this.gesuchsperiode.status || this.gesuchsperiode.status === TSGesuchsperiodeStatus.AKTIV;\n    }\n\n    public getDatumFreischaltungMax() {\n        let gueltigAb: moment.Moment  = angular.copy(this.gesuchsperiode.gueltigkeit.gueltigAb);\n        return gueltigAb.subtract(1, 'days');\n    }\n}\n"]}]}
<!--
  ~ Ki-Tax: System for the management of external childcare subsidies
  ~ Copyright (C) 2017 City of Bern Switzerland
  ~ This program is free software: you can redistribute it and/or modify
  ~ it under the terms of the GNU Affero General Public License as
  ~ published by the Free Software Foundation, either version 3 of the
  ~ License, or (at your option) any later version.
  ~ This program is distributed in the hope that it will be useful,
  ~ but WITHOUT ANY WARRANTY; without even the implied warranty of
  ~ MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
  ~ GNU Affero General Public License for more details.
  ~ You should have received a copy of the GNU Affero General Public License
  ~ along with this program. If not, see <http://www.gnu.org/licenses/>.
  -->

<div class="statistikView" dv-show-element
     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR', 'ADMINISTRATOR_SCHULAMT', 'SCHULAMT','SACHBEARBEITER_INSTITUTION', 'SACHBEARBEITER_TRAEGERSCHAFT']">
    <div class="row marginTop50">
        <div class="col-md-10 col-md-offset-1">
            <dv-accordion allow-multiple-sections="false">
                <div dv-show-element
                     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR','ADMINISTRATOR_SCHULAMT', 'SCHULAMT']">
                    <dv-accordion-tab tabid="gesuch_stichtag">
                        <tab-title data-translate="GESUCHE_NACH_STICHTAG"></tab-title>
                        <tab-body>
                            <form name="gesuch_stichtag"
                                  ng-submit="vm.generateStatistik(gesuch_stichtag, 'GESUCH_STICHTAG')" novalidate>
                                <div class="row">
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="stichtag_gesuch"
                                                   data-translate="STICHTAG"></label>
                                            <dv-datepicker name="stichtag_gesuch" id="stichtag_gesuch"
                                                           ng-model="vm.statistikParameter.stichtag" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="gesuch_stichtag.stichtag_gesuch.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="form-group">
                                            <label class="md-no-float" for="periode_gesuch_stichtag"
                                                   data-translate="GESUCHSPERIODEN"></label>
                                            <div class="dv-select-style">
                                                <select name="periode_gesuch_stichtag" id="periode_gesuch_stichtag"
                                                        ng-model="vm.statistikParameter.gesuchsperiode"
                                                        ng-options="gesuchsperiode.id as gesuchsperiode.gesuchsperiodeString for gesuchsperiode in vm.gesuchsperioden | orderBy: 'name'"
                                                        class="form-control">
                                                    <option value="">Keine</option>
                                                </select>
                                                <dv-error-messages for="gesuch_stichtag.periode_gesuch_stichtag.$error"
                                                                   class="error"></dv-error-messages>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-3 col-xs-offset-3 statistik-button">
                                        <dv-loading-button type="submit"
                                                           style="margin-left:auto;margin-right:auto;width:13rem;">
                                            <span data-translate="GENERIEREN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>
                            </form>
                            </form></tab-body>
                    </dv-accordion-tab>
                </div>
                <div dv-show-element
                     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR','ADMINISTRATOR_SCHULAMT', 'SCHULAMT']">
                    <dv-accordion-tab tabid="gesuch_zeitraum">
                        <tab-title data-translate="GESUCHE_NACH_ZEITRAUM"></tab-title>
                        <tab-body>
                            <form name="gesuch_zeitraum"
                                  ng-submit="vm.generateStatistik(gesuch_zeitraum, 'GESUCH_ZEITRAUM')" novalidate>
                                <div class="row">
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="von_gesuch" data-translate="VON"></label>
                                            <dv-datepicker name="von_gesuch" id="von_gesuch"
                                                           ng-model="vm.statistikParameter.von" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="gesuch_zeitraum.von_gesuch.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="bis_gesuch" data-translate="BIS"></label>
                                            <dv-datepicker name="bis_gesuch" id="bis_gesuch"
                                                           ng-model="vm.statistikParameter.bis" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="gesuch_zeitraum.bis_gesuch.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="form-group">
                                            <label class="md-no-float" for="periode_gesuch_zeitraum"
                                                   data-translate="GESUCHSPERIODEN"></label>
                                            <div class="dv-select-style">
                                                <select name="periode_gesuch_zeitraum" id="periode_gesuch_zeitraum"
                                                        ng-model="vm.statistikParameter.gesuchsperiode"
                                                        ng-options="gesuchsperiode.id as gesuchsperiode.gesuchsperiodeString for gesuchsperiode in vm.gesuchsperioden | orderBy: 'name'"
                                                        class="form-control">
                                                    <option value="">Keine</option>
                                                </select>
                                                <dv-error-messages for="gesuch_zeitraum.periode_gesuch_zeitraum.$error"
                                                                   class="error"></dv-error-messages>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-3 statistik-button">
                                        <dv-loading-button type="submit"
                                                           style="margin-left:auto;margin-right:auto;width:13rem;">
                                            <span data-translate="GENERIEREN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>
                            </form>
                        </tab-body>
                    </dv-accordion-tab>
                </div>

                <div dv-show-element
                     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR']">
                    <dv-accordion-tab tabid="zahlungen_periode">
                        <tab-title data-translate="ZAHLUNGEN_NACH_PERIODE"></tab-title>
                        <tab-body>
                            <form name="zahlungen_periode"
                                  ng-submit="vm.generateStatistik(zahlungen_periode, 'ZAHLUNGEN_PERIODE')" novalidate>
                                <div class="row">
                                    <div class="col-xs-3">
                                        <div class="form-group">
                                            <label class="md-no-float" for="periode_zahlungen_periode"
                                                   data-translate="GESUCHSPERIODEN"></label>
                                            <div class="dv-select-style">
                                                <select name="periode_zahlungen_periode" id="periode_zahlungen_periode"
                                                        ng-model="vm.statistikParameter.gesuchsperiode"
                                                        ng-options="gesuchsperiode.id as gesuchsperiode.gesuchsperiodeString for gesuchsperiode in vm.gesuchsperioden | orderBy: 'name'"
                                                        class="form-control" ng-required="true">
                                                </select>
                                                <dv-error-messages
                                                    for="zahlungen_periode.periode_zahlungen_periode.$error"
                                                    class="error"></dv-error-messages>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-3 statistik-button">
                                        <dv-loading-button type="submit"
                                                           style="margin-left:auto;margin-right:auto;width:13rem;">
                                            <span data-translate="GENERIEREN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>
                            </form>
                        </tab-body>
                    </dv-accordion-tab>
                </div>

                <div dv-show-element
                     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR','SACHBEARBEITER_INSTITUTION','SACHBEARBEITER_TRAEGERSCHAFT']">
                    <dv-accordion-tab tabid="kinder">
                        <tab-title data-translate="KINDER_UPPER"></tab-title>
                        <tab-body>
                            <form name="kinder"
                                  ng-submit="vm.generateStatistik(kinder, 'KINDER')" novalidate>
                                <div class="row">
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="von_kinder" data-translate="VON"></label>
                                            <dv-datepicker name="von_kinder" id="von_kinder"
                                                           ng-model="vm.statistikParameter.von" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="kinder.von_kinder.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="bis_kinder" data-translate="BIS"></label>
                                            <dv-datepicker name="bis_kinder" id="bis_kinder"
                                                           ng-model="vm.statistikParameter.bis" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="kinder.bis_kinder.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="form-group">
                                            <label class="md-no-float" for="periode_kinder"
                                                   data-translate="GESUCHSPERIODEN"></label>
                                            <div class="dv-select-style">
                                                <select name="periode_kinder" id="periode_kinder"
                                                        ng-model="vm.statistikParameter.gesuchsperiode"
                                                        ng-options="gesuchsperiode.id as gesuchsperiode.gesuchsperiodeString for gesuchsperiode in vm.gesuchsperioden | orderBy: 'name'"
                                                        class="form-control">
                                                    <option value="">Keine</option>
                                                </select>
                                                <dv-error-messages for="kinder.periode_kinder.$error"
                                                                   class="error"></dv-error-messages>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-3 statistik-button">
                                        <dv-loading-button type="submit"
                                                           style="margin-left:auto;margin-right:auto;width:13rem;">
                                            <span data-translate="GENERIEREN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>
                            </form>
                        </tab-body>
                    </dv-accordion-tab>
                </div>
                <div dv-show-element
                     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR']">
                    <dv-accordion-tab tabid="gesuchsteller">
                        <tab-title data-translate="GESUCHSTELLER_UPPER"></tab-title>
                        <tab-body>
                            <form name="gesuchsteller"
                                  ng-submit="vm.generateStatistik(gesuchsteller, 'GESUCHSTELLER')" novalidate>
                                <div class="row">
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="stichtag_gesuchsteller"
                                                   data-translate="STICHTAG"></label>
                                            <dv-datepicker name="stichtag_gesuchsteller" id="stichtag_gesuchsteller"
                                                           ng-model="vm.statistikParameter.stichtag" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="gesuchsteller.stichtag_gesuchsteller.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3 col-xs-offset-6 statistik-button">
                                        <dv-loading-button type="submit">
                                            <span data-translate="GENERIEREN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>
                            </form>
                        </tab-body>
                    </dv-accordion-tab>
                </div>
                <div dv-show-element
                     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR','SACHBEARBEITER_INSTITUTION','SACHBEARBEITER_TRAEGERSCHAFT']">
                    <dv-accordion-tab tabid="kanton">
                        <tab-title data-translate="KANTON"></tab-title>
                        <tab-body>
                            <form name="kanton"
                                  ng-submit="vm.generateStatistik(kanton, 'KANTON')" novalidate>
                                <div class="row">
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="von_kanton" data-translate="VON"></label>
                                            <dv-datepicker name="von_kanton" id="von_kanton"
                                                           ng-model="vm.statistikParameter.von" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="kanton.von_kanton.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="bis_kanton" data-translate="BIS"></label>
                                            <dv-datepicker name="bis_kanton" id="bis_kanton"
                                                           ng-model="vm.statistikParameter.bis" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="kanton.bis_kanton.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3 col-xs-offset-3 statistik-button">
                                        <dv-loading-button type="submit">
                                            <span data-translate="GENERIEREN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>
                            </form>
                        </tab-body>
                    </dv-accordion-tab>
                </div>
                <div dv-show-element
                     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR']">
                    <dv-accordion-tab tabid="mitarbeiterinnen">
                        <tab-title data-translate="MITARBEITERINNEN"></tab-title>
                        <tab-body>
                            <form name="mitarbeiterinnen"
                                  ng-submit="vm.generateStatistik(mitarbeiterinnen, 'MITARBEITERINNEN')" novalidate>
                                <div class="row">
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="von_mitarbeiterinnen"
                                                   data-translate="VON"></label>
                                            <dv-datepicker name="von_mitarbeiterinnen" id="von_mitarbeiterinnen"
                                                           ng-model="vm.statistikParameter.von" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="mitarbeiterinnen.von_mitarbeiterinnen.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="bis_mitarbeiterinnen"
                                                   data-translate="BIS"></label>
                                            <dv-datepicker name="bis_mitarbeiterinnen" id="bis_mitarbeiterinnen"
                                                           ng-model="vm.statistikParameter.bis" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="mitarbeiterinnen.bis_mitarbeiterinnen.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3 col-xs-offset-3 statistik-button">
                                        <dv-loading-button type="submit">
                                            <span data-translate="GENERIEREN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>
                            </form>
                        </tab-body>
                    </dv-accordion-tab>
                </div>
                <div dv-show-element
                     dv-show-allowed-roles="['SACHBEARBEITER_JA','ADMIN','SUPER_ADMIN','REVISOR']">
                    <dv-accordion-tab tabid="betreuung">
                        <tab-title data-translate="GESUCHSTELLER_KINDER_BETREUUNG"></tab-title>
                        <tab-body>
                            <form name="betreuung"
                                  ng-submit="vm.generateStatistik(betreuung, 'GESUCHSTELLER_KINDER_BETREUUNG')"
                                  novalidate>
                                <div class="row">
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="von_betreuung" data-translate="VON"></label>
                                            <dv-datepicker name="von_betreuung"
                                                           ng-model="vm.statistikParameter.von" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="betreuung.von_betreuung.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <dv-input-container class="form-group">
                                            <label class="md-no-float" for="bis_betreuung" data-translate="BIS"></label>
                                            <dv-datepicker name="bis_betreuung" id="bis_betreuung"
                                                           ng-model="vm.statistikParameter.bis" ng-required="true"
                                                           class="input-element"
                                                           dv-min-date="vm.minDate" dv-max-date="vm.maxDate">
                                            </dv-datepicker>
                                            <dv-error-messages for="betreuung.bis_betreuung.$error"
                                                               class="error"></dv-error-messages>
                                        </dv-input-container>
                                    </div>
                                    <div class="col-xs-3">
                                        <div class="form-group">
                                            <label class="md-no-float" for="periode_betreuung"
                                                   data-translate="GESUCHSPERIODEN"></label>
                                            <div class="dv-select-style">
                                                <select name="periode_betreuung" id="periode_betreuung"
                                                        ng-model="vm.statistikParameter.gesuchsperiode"
                                                        ng-options="gesuchsperiode.id as gesuchsperiode.gesuchsperiodeString for gesuchsperiode in vm.gesuchsperioden | orderBy: 'name'"
                                                        class="form-control">
                                                    <option value="">Keine</option>
                                                </select>
                                                <dv-error-messages for="betreuung.periode_betreuung.$error"
                                                                   class="error"></dv-error-messages>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-xs-3 statistik-button">
                                        <dv-loading-button type="submit">
                                            <span data-translate="GENERIEREN"></span>
                                        </dv-loading-button>
                                    </div>
                                </div>
                            </form>
                        </tab-body>
                    </dv-accordion-tab>
                </div>
            </dv-accordion>
        </div>
    </div>

    <!-- BatchJobs -->
    <div class="row marginTop40">

        <div class="col-md-10 col-md-offset-1">
            <h2>
                <span data-translate="Letzte Reports"></span>
                {{vm.titleValue}}
            </h2>

            <table st-table="displayedCollection" st-safe-src="vm.userjobs"
                   class="table table-hover" id="{{vm.tableId}}" title="{{vm.tableTitle}}">
                <thead>
                <tr>
                    <th data-translate="TYP"></th>
                    <th data-translate="ERSTELLT"></th>
                    <th data-translate="GESTARTET"></th>
                    <th data-translate="BEENDET"></th>
                    <th data-translate="STATUS"></th>

                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="row in displayedCollection" st-select-row="row" st-select-mode="single"
                    ng-click="vm.rowClicked(row)" role="row" tabindex="-1">
                    <td>
                        <span ng-if="row.params" ng-bind="row.params | translate"
                              title="{{row.requestURI}}"></span>
                    </td>
                    <td ng-bind="row.timestampErstellt | amDateFormat : 'DD.MM.YYYY HH:mm'"></td>
                    <td ng-if="row.execution.startTime"
                        ng-bind="row.execution.startTime | amDateFormat : 'DD.MM.YYYY HH:mm'"></td>
                    <td ng-if="row.execution.endTime"
                        ng-bind="row.execution.endTime | amDateFormat : 'DD.MM.YYYY HH:mm'"></td>
                    <td ng-bind="row.batchJobStatus | translate"></td>
                    <td class="dateientable-td symbol">
                                <span ng-if="row.execution && row.execution.batchStatus === 'COMPLETED'"
                                      class="fa fa-download"
                                      title="{{'DOKUMENT_DOWNLOAD' | translate}}"
                                      aria-label="{{'DOKUMENT_DOWNLOAD' | translate}}"
                                      style="color: black"></span>
                    </td>

                <tr ng-if="vm.userjobs.length === 0">
                    <td colspan="5" class="empty-table" data-translate="KEIN_EINTRAG">...</td>
                </tr>
                </tbody>
            </table>

        </div>
    </div>

    <div class="col-md-10 col-md-offset-1 marginTop40">
        <div dv-display-element
             dv-display-allowed-roles="vm.TSRoleUtil.getSuperAdminRoles()">

            <dv-loading-button button-class="" button-click="vm.showAllJobs()" type="button">
                <span class="fa fa-refresh"></span>
                <span  data-translate="SHOW_JOBS"></span>
            </dv-loading-button>
            </dv-loading-button>
            <div ng-if="vm.allJobs">
                <p>Batch Jobs from Wildfly Batch Module</p>
            <pre>{{vm.allJobs |json}}</pre>
            </div>
        </div>
    </div>

</div>
